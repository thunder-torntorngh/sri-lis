<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistema SRI Web - Estilo Moderno</title>

    <style>
      * {
        box-sizing: border-box;
        font-family: 'Arial', sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        color: #333;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .error-message {
        display: none; 
        color: red;
      }


      .consulta-container {
  background: #ffffff;
  border: 1px solid #ccc;
  padding: 20px;
  border-radius: 6px;
  max-width: 600px;
  margin: 20px auto;
  font-family: Arial, sans-serif;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.consulta-container h3 {
  color: #004884;
  text-align: center;
  margin-bottom: 18px;
}

.input {
  width: 100%;
  padding: 8px;
  margin: 8px 0 16px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

.btn-consultar {
  width: 100%;
  background: #004884;
  color: #fff;
  border: none;
  padding: 10px;
  font-size: 15px;
  border-radius: 4px;
  cursor: pointer;
}

.btn-consultar:hover {
  background: #003366;
}

.resultado-consulta {
  margin-top: 20px;
}

.resultado-header p {
  margin: 4px 0;
  font-size: 14px;
}

.tabla-rubros {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

.tabla-rubros th,
.tabla-rubros td {
  border: 1px solid #ddd;
  padding: 8px;
  font-size: 14px;
}

.tabla-rubros th {
  background: #f5f5f5;
  text-align: center;
}

.tabla-rubros tfoot td {
  background: #f9f9f9;
  font-size: 15px;
}

.resultado-acciones {
  margin-top: 15px;
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

.resultado-acciones button {
  background: #0066cc;
  color: #fff;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.resultado-acciones button:hover {
  background: #0055aa;
}



      /* --- Login --- */
      #login-container {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: linear-gradient(135deg, #004b8d, #0077cc);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .login-box {
        width: 350px;
        padding: 30px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: all 0.3s ease;
      }

      .login-box.hidden {
        transform: translateY(-20px);
        opacity: 0;
      }

      .login-box h2 {
        color: #004b8d;
        margin-bottom: 20px;
      }

      /* --- Sidebar --- */
      .sidebar {
        position: fixed;
        top: 0; left: 0;
        height: 100vh;
        width: 240px;
        background-color: #002b5c;
        color: white;
        box-shadow: 2px 0 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        overflow-y: auto;
      }

      .sidebar .logo {
        text-align: center;
        font-size: 26px;
        font-weight: bold;
        padding: 20px;
        background: #004b8d;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .nav-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .nav-list li {
        padding: 15px 20px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .nav-list li:hover {
        background-color: #0069d9;
      }

      /* --- Topbar --- */
      .topbar {
        position: fixed;
        top: 0; left: 240px;
        height: 60px;
        width: calc(100% - 240px);
        background-color: #004b8d;
        color: white;
        display: flex;
        align-items: center;
        padding: 0 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 999;
      }

      .topbar h1 {
        margin: 0;
        font-size: 20px;
        font-weight: bold;
      }

      /* --- Contenedor principal --- */
      .main-container {
        margin-left: 240px;
        margin-top: 60px;
        padding: 20px;
        flex: 1;
        padding-bottom: 60px; /* Espacio para footer */
      }

      /* --- Footer --- */
      footer {
        text-align: center;
        padding: 12px;
        background: #004b8d;
        color: white;
        height: 50px;
        line-height: 50px;
        font-size: 16px;
        position: relative;
        width: 100%;
      }

      /* --- Responsive --- */
      @media (max-width: 900px) {
        .sidebar {
          width: 200px;
        }

        .topbar {
          left: 200px;
          width: calc(100% - 200px);
        }

        .main-container {
          margin-left: 200px;
        }
      }

      @media (max-width: 600px) {
        .sidebar {
          width: 100%;
          height: auto;
          position: relative;
        }

        .topbar {
          left: 0;
          width: 100%;
          position: relative;
        }

        .main-container {
          margin-left: 0;
          margin-top: 0;
          padding-top: 20px;
        }
      }

      /* --- Botones, Formularios y Estilos Secundarios (resumen) --- */
      button {
        padding: 10px 16px;
        background-color: #004b8d;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #0069d9;
      }

      h2, h3, h4 {
        color: #004b8d;
      }

      .input-group input,
      input, select {
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        width: 100%;
      }

      .modulo {
        display: none;
      }

      .modulo.active {
        display: block;
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      }

      /* --- Formulario RUC --- */
    #formularioRUC {
        max-width: 500px;
        margin: 30px auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    #formularioRUC h3 {
        text-align: center;
        color: #004b8d;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: bold;
    }

    #formularioRUC form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    #formularioRUC input,
    #formularioRUC select {
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    #formularioRUC input:focus,
    #formularioRUC select:focus {
        border-color: #3498db;
        outline: none;
    }

    #formularioRUC button {
        padding: 12px;
        background-color: #004b8d;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #formularioRUC button:hover {
        background-color: #0069d9;
    }

    /* --- Facturaci√≥n: centrado y estilos --- */
    #facturacion {
        display: flex; /* Cambiado a flex */
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    #facturacion .subopciones {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
        width: 100%;
    }

    #facturacion .subopciones button {
        width: 280px;
        background-color: #004b8d;
        color: #fff;
        padding: 12px 20px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-align: center;
        transition: background-color 0.3s ease;
    }

    #facturacion .subopciones button:hover {
        background-color: #0069d9;
    }

    #facturacion h2 {
        color: #004b8d;
        margin-bottom: 10px;
    }

    /* --- Formularios de facturaci√≥n --- */
    #facturacionFisica,
    #facturacionElectronica {
        max-width: 600px;
        margin: 30px auto;
        padding: 25px;
        background-color: #ffffff;
        border-radius: 10px;
        border: 1px solid #ddd;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
    }

    #facturacionElectronica {
        background-color: #eef6ff;
    }

    #facturacionFisica h2,
    #facturacionElectronica h2,
    #facturacionFisica form,
    #facturacionElectronica form {
        text-align: center;
    }

    #facturacionFisica form,
    #facturacionElectronica form {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }

    #facturacionFisica input,
    #facturacionElectronica input {
        width: 100%;
        max-width: 480px;
        padding: 10px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 6px;
    }

    #facturacionFisica button,
    #facturacionElectronica button {
        background-color: #28a745;
        border: none;
        padding: 12px;
        border-radius: 6px;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #facturacionFisica button:hover,
    #facturacionElectronica button:hover {
        background-color: #218838;
    }

      .consulta-container {
    background-color: #f0f4f8;
    padding: 20px;
    border-radius: 8px;
    max-width: 600px;
    margin: 20px auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    font-family: Arial, sans-serif;
  }

  .consulta-container h3 {
    color: #003366;
    margin-bottom: 15px;
    text-align: center;
  }

  .input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .btn-consultar {
    background-color: #0066cc;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    font-weight: bold;
  }

  .btn-consultar:hover {
    background-color: #004a99;
  }

  .resultado-consulta {
    margin-top: 20px;
  }

      
    </style>


  </head>
  <body>
    <!-- Login Interface -->
    <div id="login-container">
        <div class="login-box" id="login-box">
            <h2>Iniciar Sesi√≥n</h2>
            
            <div class="input-group">
                <input type="text" id="inputUsername" placeholder="Ingresa tu usuario">
                <input type="password" id="inputPassword" placeholder="Ingresa tu contrase√±a">
            </div>
            
            <button class="login-btn" onclick="attemptLogin()">Ingresar</button>
            <div id="error-message" class="error-message">Usuario o contrase√±a incorrectos</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div id="main-content" style="display: none;">

      <!-- Men√∫ lateral -->
      <aside class="sidebar" id="sidebar">
        <div class="logo">SRI</div>
        <ul class="nav-list">
          <li onclick="mostrar('dimm')"><span>ü™™</span> DIMM</li>
          <li onclick="mostrar('facturacion')"><span>üìÑ</span> Facturaci√≥n</li>
          <li onclick="mostrar('anexos')"><span>üìÇ</span> Anexos</li>
          <li onclick="mostrar('deudas')"><span>üìâ</span> Deudas</li>
          <li onclick="mostrar('vehiculos')"><span>üöó</span> Veh√≠culos</li>
          <li onclick="mostrar('grafica')"><span>üìä</span> Gr√°fica</li>
        </ul>
      </aside>

      <!-- Encabezado superior -->
      <header class="topbar">
        <h1 class="topbar-title">Sistema Web - SRI</h1>
        
        <div id="usuarioInfo" style="display: none;">
          <span id="nombreUsuario">üë§</span>
          <button onclick="cerrarSesion()" style="background: none; border: none; color: #004b8d; cursor: pointer; font-size: 18px;">üö™</button>
        </div>
      </header>


      <!-- Contenido principal -->
      <main class="main-container">
        <section id="inicio" class="modulo">
          <h2>Bienvenido al Sistema Web del SRI</h2>
          <p>Selecciona una opci√≥n del men√∫ para continuar.</p>
        </section>

        <!-- M√≥dulo DIMM -->
        <section id="dimm" class="modulo">
          <h2>Gesti√≥n de RUC</h2>
          <div class="subopciones">
            <button onclick="nuevoRUC()">Nuevo</button>
            <button onclick="editarRUC()">Editar</button>
            <button onclick="eliminarRUC()">Eliminar</button>
          </div>
          <div id="contenidoDIMM"></div>
        </section>


        <!-- M√≥dulo de Veh√≠culos -->
        <section id="vehiculos" class="modulo" style="display: none; text-align: center;">
          <h2>Consultar sus reportes</h2>
          <div class="subopciones">
            <button onclick="mostrarConsultaVehiculo('placa')">Consultar reportes</button>
            <button onclick="volverAConsulta()" class="btn-volver">Volver a Consulta </button>
          </div>

          <div id="contenidoVehiculo"></div>
          <div id="seccionPagosRealizados" style="margin-top: 40px;"></div>
          <div id="modalDetallesPago" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:2px solid #444; max-width:90%; max-height:80%; overflow-y:auto; z-index:1000;"></div>
          <div id="modalPagoTarjeta" style="display:none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: white; border: 2px solid #444; padding: 20px; max-width: 400px; z-index: 10000;"></div>
        </section>






        <!-- M√≥dulo Deudas -->
        <section id="deudas" class="modulo" style="display:center;">
          <h2>M√≥dulo Deudas</h2>
          <div class="subopciones">
            <button onclick="mostrarConsultaDeudas()">Consultar Deudas</button>
            <button id="btnPagarDeudas" onclick="mostrarPagoDeudas()" disabled>Pagar Deudas</button>
            <button id="btnFacilidadesPago" onclick="mostrarFacilidadesPago()" disabled>Solicitar Facilidades de Pago</button>
          </div>

          <div id="contenidoDeudas"></div>
        </section>

        <!-- M√≥dulo Anexos -->
        <section id="anexos" class="modulo hidden">
          <h2>M√≥dulo Anexos</h2>
          <div class="subopciones">
            <button onclick="mostrarEnvioConsultaAnexos()">Env√≠o y Consulta de Anexos</button>
            <button onclick="mostrarGastosPersonales()">Anexo de Gastos Personales en L√≠nea</button>
          </div>

          <div id="contenidoAnexos"></div>
        </section>


        
  <!-- M√≥dulo Gr√°fica -->
  <section id="grafica" class="modulo">
    <h2>Gr√°fica General</h2>
    <div id="graficas" style="text-align: center;">
      <button onclick="mostrarGrafica()" style="margin-bottom: 15px; padding: 10px 20px; background-color: #0c3a70; color: white; border: none; border-radius: 5px; cursor: pointer;">
        üìä Generar gr√°fica
      </button>
      <canvas id="graficaSistema" max-width="600" margin="auto" ></canvas>
    </div>
  </section>

    
  <!-- M√≥dulo Facturaci√≥n -->
  <section id="facturacion" class="modulo" style="display: none;"> <!-- Aseg√∫rate de que est√© oculto por defecto -->
    <h2>Autorizaci√≥n de Facturaci√≥n</h2>
    <div class="subopciones">
      <button onclick="mostrarFacturacionFisica()">üìÑ Facturaci√≥n F√≠sica</button>
      <button onclick="mostrarFacturacionElectronica()">üíª Facturaci√≥n Electr√≥nica</button>
    </div>


    <!-- Contenedor para Facturaci√≥n F√≠sica -->
  <div id="facturacionFisica" style="display:none; padding: 20px; background-color: #fff; border-radius: 8px; margin-top: 10px;">
    <h2>Facturaci√≥n F√≠sica - Simulador SRI</h2>
    <form id="formFacturaFisica">
      <h4>Datos del Emisor</h4>
      <input type="text" placeholder="Raz√≥n Social" id="emisor" required><br>
      <input type="text" placeholder="RUC" id="rucEmisor" required><br>
      <input type="text" placeholder="Direcci√≥n" id="direccionEmisor" required><br>

      <h4>Datos del Cliente</h4>
      <input type="text" placeholder="Nombre del Cliente" id="cliente" required><br>
      <input type="text" placeholder="C√©dula/RUC Cliente" id="rucCliente" required><br>

      <h4>Detalles de la Factura</h4>
      <input type="text" placeholder="Descripci√≥n del Producto o Servicio" id="detalle" required><br>
      <input type="number" placeholder="Cantidad" id="cantidad" required><br>
      <input type="number" placeholder="Precio Unitario" id="precio" required><br>

      <button type="button" onclick="generarFacturaFisica()">üìù Generar Factura F√≠sica</button>
    </form>
  </div>

  <!-- Contenedor para Facturaci√≥n Electr√≥nica -->
  <div id="facturacionElectronica" style="display:none; padding: 20px; background-color: #eef; border-radius: 8px; margin-top: 10px;">
    <h2>Facturaci√≥n Electr√≥nica - Simulador SRI</h2>
    <form id="formFacturaElectronica">
      <h4>Datos del Emisor</h4>
      <input type="text" placeholder="Raz√≥n Social" id="emisorE" required><br>
      <input type="text" placeholder="RUC" id="rucEmisorE" required><br>
      <input type="text" placeholder="Direcci√≥n" id="direccionEmisorE" required><br>

      <h4>Datos del Cliente</h4>
      <input type="text" placeholder="Nombre del Cliente" id="clienteE" required><br>
      <input type="text" placeholder="C√©dula/RUC Cliente" id="rucClienteE" required><br>

      <h4>Detalle de la Factura</h4>
      <input type="text" placeholder="Producto o Servicio" id="detalleE" required><br>
      <input type="number" placeholder="Cantidad" id="cantidadE" required><br>
      <input type="number" placeholder="Precio Unitario" id="precioE" required><br>

      <button type="button" onclick="generarFacturaElectronica()">üì§ Emitir Factura Electr√≥nica</button>
    </form>
  </div>


  </section>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
          //VARIABLES 
          let listaRUCs = []; 
          let registrosDIMM = [];
          let anexosGuardados = [];


          



          //INICIO DE SECCION

          function attemptLogin() {
            const username = document.getElementById('inputUsername').value;
            const password = document.getElementById('inputPassword').value;
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.style.display = 'none';
            
            if(username === 'Lis' && password === '12345') {
                console.log("Inicio de sesi√≥n correcto");
                
                // Ocultar login box con animaci√≥n
                document.getElementById('login-box').classList.add('hidden');
                
                // Mostrar contenido principal despu√©s de la animaci√≥n
                setTimeout(() => {
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    document.getElementById('username-display').textContent = username;
                }, 300);
            } else {
                console.warn("Fallo en inicio de sesi√≥n");
                errorMessage.style.display = 'block';
                document.getElementById('inputPassword').value = '';
            }
          }




          // SECCI√ìN RUC - Generaci√≥n del formulario
      function nuevoRUC() {
        const contenido = document.getElementById("contenidoDIMM");

        contenido.innerHTML = `
          <div id="formularioRUC" class="form-card">
            <h3 class="form-title">Registrar RUC</h3>
            <form onsubmit="return validarFormularioRUC()" class="form-body">
              <div class="form-group">
                <input type="text" id="ruc" placeholder="RUC (13 d√≠gitos)" required />
              </div>
              <div class="form-group">
                <input type="text" id="razonSocial" placeholder="Raz√≥n Social" required />
              </div>
              <div class="form-group">
                <input type="text" id="direccion" placeholder="Direcci√≥n Matriz" required />
              </div>
              <div class="form-group">
                <input type="text" id="celular" placeholder="N√∫mero Celular (10 d√≠gitos)" required />
              </div>
              <div class="form-group">
                <input type="email" id="correo" placeholder="Correo Electr√≥nico" required />
              </div>
              <div class="form-group">
                <select id="tipoIdentificacion" required onchange="actualizarPlaceholder()">
                  <option value="">Seleccione tipo de identificaci√≥n</option>
                  <option value="cedula">C√©dula</option>
                  <option value="pasaporte">Pasaporte</option>
                </select>
              </div>
              <div class="form-group">
                <input type="text" id="identificacion" placeholder="N√∫mero de C√©dula o Pasaporte" required />
              </div>
              <div class="form-group">
                <button type="submit">Registrar</button>
              </div>
            </form>
          </div>
        `;
      }


      // Validaci√≥n del formulario RUC
      function validarFormularioRUC() {
        const ruc = document.getElementById('ruc').value.trim();
        const razonSocial = document.getElementById('razonSocial').value.trim();
        const direccion = document.getElementById('direccion').value.trim();
        const celular = document.getElementById('celular').value.trim();
        const correo = document.getElementById('correo').value.trim();
        const tipoID = document.getElementById('tipoIdentificacion').value;
        const identificacion = document.getElementById('identificacion').value.trim();

        // Validaciones...
        if (!/^\d{13}$/.test(ruc) || !ruc.endsWith("001")) {
          alert("El RUC debe tener 13 d√≠gitos num√©ricos y terminar en '001'.");
          return false;
        }
        if (razonSocial.length < 3) {
          alert("La raz√≥n social debe tener al menos 3 caracteres.");
          return false;
        }
        if (direccion.length < 5) {
          alert("La direcci√≥n matriz debe tener al menos 5 caracteres.");
          return false;
        }
        if (!/^09\d{8}$/.test(celular)) {
          alert("El n√∫mero celular debe tener 10 d√≠gitos y comenzar con '09'.");
          return false;
        }
        const correoRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.([a-z]{2,}|com|net|org|edu|ec|gob\.ec)$/i;
        if (!correoRegex.test(correo)) {
          alert("El correo debe tener un formato v√°lido y usar un dominio permitido.");
          return false;
        }
        if (tipoID === "cedula") {
          if (!/^\d{10}$/.test(identificacion)) {
            alert("La c√©dula debe tener exactamente 10 d√≠gitos.");
            return false;
          }
        } else if (tipoID === "pasaporte") {
          if (!/^[a-zA-Z0-9]{6,12}$/.test(identificacion)) {
            alert("El pasaporte debe tener entre 6 y 12 caracteres alfanum√©ricos.");
            return false;
          }
        } else {
          alert("Debe seleccionar un tipo de identificaci√≥n.");
          return false;
        }

        // Guardar en array
        const nuevoRUC = {
          ruc,
          razonSocial,
          direccion,
          celular,
          correo,
          tipoID,
          identificacion
        };

        listaRUCs.push(nuevoRUC);

        alert("Formulario enviado correctamente.");
        return false; // Previene que el form recargue
      }


      // Actualiza el texto del placeholder seg√∫n el tipo de identificaci√≥n
      function actualizarPlaceholder() {
        const tipo = document.getElementById("tipoIdentificacion").value;
        const input = document.getElementById("identificacion");

        if (tipo === "cedula") {
          input.placeholder = "N√∫mero de C√©dula (10 d√≠gitos)";
        } else if (tipo === "pasaporte") {
          input.placeholder = "N√∫mero de Pasaporte (6 a 12 caracteres)";
        } else {
          input.placeholder = "N√∫mero de C√©dula o Pasaporte";
        }
      }

      //EDICION DE RUC
      function editarRUC() {
        const contenido = document.getElementById("contenidoDIMM");

        if (listaRUCs.length === 0) {
          contenido.innerHTML = `<p>No hay RUCs registrados para editar.</p>`;
          return;
        }

        let html = `<h3>Editar RUC</h3>`;
        html += `<ul style="list-style: none; padding: 0;">`;

        listaRUCs.forEach((rucObj, index) => {
          html += `
            <li style="margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 6px;">
              <strong>${rucObj.razonSocial}</strong> (${rucObj.ruc})
              <br/>
              <button onclick="cargarEdicionRUC(${index})">Editar</button>
            </li>
          `;
        });

        html += `</ul>`;
        contenido.innerHTML = html;
      }

      function cargarEdicionRUC(index) {
        const r = listaRUCs[index];
        const contenido = document.getElementById("contenidoDIMM");

        contenido.innerHTML = `
          <h3>Editar RUC</h3>
          <form onsubmit="return guardarCambiosRUC(${index})">
            <input type="text" id="rucEdit" value="${r.ruc}" required /><br/>
            <input type="text" id="razonSocialEdit" value="${r.razonSocial}" required /><br/>
            <input type="text" id="direccionEdit" value="${r.direccion}" required /><br/>
            <input type="text" id="celularEdit" value="${r.celular}" required /><br/>
            <input type="email" id="correoEdit" value="${r.correo}" required /><br/>
            <input type="text" id="identificacionEdit" value="${r.identificacion}" required /><br/>
            <button type="submit">Guardar Cambios</button>
          </form>
        `;
      }

      //GUARDADO DE RUC EDITADO
      function guardarCambiosRUC(index) {
        listaRUCs[index].ruc = document.getElementById("rucEdit").value.trim();
        listaRUCs[index].razonSocial = document.getElementById("razonSocialEdit").value.trim();
        listaRUCs[index].direccion = document.getElementById("direccionEdit").value.trim();
        listaRUCs[index].celular = document.getElementById("celularEdit").value.trim();
        listaRUCs[index].correo = document.getElementById("correoEdit").value.trim();
        listaRUCs[index].identificacion = document.getElementById("identificacionEdit").value.trim();

        alert("Cambios guardados correctamente.");
        mostrar("dimm"); // Regresa a m√≥dulo
        return false;
      }

      //ELIMINACION DE RUC
      function eliminarRUC() {
        const contenido = document.getElementById("contenidoDIMM");

        if (listaRUCs.length === 0) {
          contenido.innerHTML = `<p>No hay RUCs registrados para eliminar.</p>`;
          return;
        }

        let html = `<h3>Eliminar RUC</h3>`;
        html += `<ul style="list-style: none; padding: 0;">`;

        listaRUCs.forEach((rucObj, index) => {
          html += `
            <li style="margin-bottom: 10px; background: #fce9e9; padding: 10px; border-radius: 6px;">
              <strong>${rucObj.razonSocial}</strong> (${rucObj.ruc})
              <br/>
              <button onclick="confirmarEliminarRUC(${index})" style="background-color: red;">Eliminar</button>
            </li>
          `;
        });

        html += `</ul>`;
        contenido.innerHTML = html;
      }

      function confirmarEliminarRUC(index) {
        if (confirm("¬øEst√° seguro de eliminar este RUC?")) {
          listaRUCs.splice(index, 1);
          alert("RUC eliminado correctamente.");
          eliminarRUC(); // Actualizar vista
        }
      }


      //MOSTRAR MODULOS
        function mostrar(modulo) {
          const modulos = document.querySelectorAll('.modulo');
          modulos.forEach(m => {
            m.classList.add('hidden');
            m.classList.remove('active');
            m.style.display = 'none'; // Aseg√∫rate de ocultar el m√≥dulo
          });
          const target = document.getElementById(modulo);
          if (target) {
            target.classList.remove('hidden');
            target.classList.add('active');
            target.style.display = 'block'; // Mostrar el m√≥dulo seleccionado
          }
        }

        //================================================== Anexos =============================================
        //=======================================================================================================

      let idEditar = null;

      // Mostrar m√≥dulo para crear/editar anexos, importar, descargar, enviar y eliminar
      function mostrarEnvioConsultaAnexos() {
        mostrar('anexos');

        const contenido = `
          <div style="margin-top: 15px;">
            <button onclick="mostrarFormNuevoAnexo()">Nuevo Anexo</button>
            <button onclick="mostrarListaAnexos()">Lista de Anexos</button>
          </div>

          <div id="formAnexo" style="display:none; margin-top: 15px;"></div>
          <div id="listaAnexos" style="margin-top: 15px;"></div>
        `;

        document.getElementById('contenidoAnexos').innerHTML = contenido;

        mostrarListaAnexos();
      }

      function mostrarFormNuevoAnexo() {
        idEditar = null;
        const formHtml = `
          <h3 id="tituloForm">Crear Nuevo Anexo</h3>

          <label>Importar archivo (.txt, .xls, .xlsx):</label><br/>
          <input type="file" id="inputFileAnexo" accept=".txt, .xls, .xlsx" onchange="cargarArchivo(event)"/>

          <label for="nombreAnexo">Nombre del anexo:</label>
          <input type="text" id="nombreAnexo" placeholder="Ejemplo: anexo1.txt" style="width: 100%; padding: 8px; margin-bottom: 10px;"/>

          <label for="contenidoAnexo">Contenido del anexo:</label>
          <textarea id="contenidoAnexo" rows="10" style="width: 100%; padding: 8px;"></textarea>

          <div style="margin-top: 10px;">
            <button onclick="guardarAnexo()">Guardar</button>
            <button onclick="limpiarForm()">Cancelar</button>
          </div>
        `;
        document.getElementById('formAnexo').innerHTML = formHtml;
        document.getElementById('formAnexo').style.display = 'block';
        document.getElementById('listaAnexos').style.display = 'none';
        limpiarForm();
      }

      function mostrarListaAnexos() {
        document.getElementById('formAnexo').style.display = 'none';
        document.getElementById('listaAnexos').style.display = 'block';
        renderizarAnexos();
      }

      function limpiarForm() {
        const fileInput = document.getElementById('inputFileAnexo');
        if (fileInput) fileInput.value = '';
        const nombre = document.getElementById('nombreAnexo');
        if (nombre) nombre.value = '';
        const contenido = document.getElementById('contenidoAnexo');
        if (contenido) contenido.value = '';
      }

      // Cargar archivo .txt y excel para mostrar en el textarea y el nombre
      function cargarArchivo(event) {
        const file = event.target.files[0];
        if (!file) return;

        const nombreInput = document.getElementById('nombreAnexo');
        const contenidoInput = document.getElementById('contenidoAnexo');

        const ext = file.name.split('.').pop().toLowerCase();

        if (ext === "txt") {
          const reader = new FileReader();
          reader.onload = function(e) {
            contenidoInput.value = e.target.result;
            nombreInput.value = file.name;
          };
          reader.readAsText(file);

        } else if (ext === "xls" || ext === "xlsx") {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const data = e.target.result;
              const workbook = XLSX.read(data, { type: "array" });
              const primeraHoja = workbook.Sheets[workbook.SheetNames[0]];
              const csv = XLSX.utils.sheet_to_csv(primeraHoja);
              contenidoInput.value = csv;
              nombreInput.value = file.name;
            } catch (error) {
              alert("Error al leer el archivo Excel: " + error.message);
              nombreInput.value = "";
              contenidoInput.value = "";
            }
          };
          reader.readAsArrayBuffer(file);

        } else {
          alert("Solo se aceptan archivos .txt, .xls o .xlsx");
          event.target.value = "";
        }
      }

function guardarAnexo() {
    const nombre = document.getElementById('nombreAnexo').value.trim();
    const contenido = document.getElementById('contenidoAnexo').value.trim();

    // Validaciones
    if (!nombre) {
        alert("Debe ingresar un nombre para el anexo");
        return;
    }
    if (!contenido) {
        alert("El contenido no puede estar vac√≠o");
        return;
    }

    if (idEditar === null) {
        // Agregar nuevo anexo
        anexosGuardados.push({
            id: Date.now(), // Generar un ID √∫nico basado en la fecha
            nombre,
            contenido
        });
        alert("Anexo guardado con √©xito");
    } else {
        // Actualizar anexo existente
        const index = anexosGuardados.findIndex(a => a.id === idEditar);
        if (index !== -1) {
            // Actualizar el anexo en la posici√≥n encontrada
            anexosGuardados[index].nombre = nombre;
            anexosGuardados[index].contenido = contenido;
            alert("Anexo actualizado con √©xito");
        }
        idEditar = null; // Limpiar el ID de edici√≥n despu√©s de guardar
    }

    limpiarForm(); // Limpiar el formulario
    mostrarListaAnexos(); // Volver a mostrar la lista de anexos
}

function renderizarAnexos() {
    const lista = document.getElementById("listaAnexos");
    lista.innerHTML = ""; // Limpiar la lista antes de renderizar

    if (anexosGuardados.length === 0) {
        lista.innerHTML = "<p>No hay anexos guardados.</p>";
        return;
    }

    anexosGuardados.forEach(anexo => {
        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.padding = "10px";
        div.style.marginBottom = "10px";
        div.style.borderRadius = "5px";

        div.innerHTML = `
            <strong>Nombre:</strong> ${anexo.nombre}<br/><br/>
            <pre style="background:#f4f4f4; padding:10px; border-radius:4px; max-height:150px; overflow:auto;">${anexo.contenido}</pre>
            <div style="margin-top: 10px;">
                <button onclick="editarAnexo(${anexo.id})">‚úèÔ∏è Editar</button>
                <button onclick="descargarAnexo(${anexo.id})">üì• Descargar</button>
                <button onclick="simularEnvio(${anexo.id})">üì§ Enviar</button>
                <button onclick="eliminarAnexo(${anexo.id})" style="color:red;">üóëÔ∏è Eliminar</button>
            </div>
        `;

        lista.appendChild(div); // Agregar el div a la lista
    });
}

function editarAnexo(id) {
    const anexo = anexosGuardados.find(a => a.id === id);
    if (!anexo) return;

    idEditar = id; // Establecer el ID del anexo que se est√° editando
    mostrarFormNuevoAnexo(); // Mostrar el formulario para editar

    // Actualizar t√≠tulo del formulario
    document.getElementById('tituloForm').innerText = "Editar Anexo";

    // Llenar el formulario con los datos del anexo existente
    document.getElementById('nombreAnexo').value = anexo.nombre;
    document.getElementById('contenidoAnexo').value = anexo.contenido;
}

      function descargarAnexo(id) {
        const anexo = anexosGuardados.find(a => a.id === id);
        if (!anexo) return;

        const blob = new Blob([anexo.contenido], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = anexo.nombre;
        link.click();
      }

      function simularEnvio(id) {
        const anexo = anexosGuardados.find(a => a.id === id);
        if (!anexo) return;

        alert(`El anexo "${anexo.nombre}" ha sido enviado con √©xito.\nContenido:\n${anexo.contenido}`);
      }

      function eliminarAnexo(id) {
        if (!confirm("¬øEst√° seguro que desea eliminar este anexo?")) return;

        anexosGuardados = anexosGuardados.filter(a => a.id !== id);
        renderizarAnexos();
      }



        function mostrarGastosPersonales() {
        mostrar('anexos');

        const contenido = `
          <h3>Anexo de Gastos Personales</h3>
          <p>Selecciona una opci√≥n:</p>
          <button onclick="mostrarBeneficiario()">Beneficiario de pensi√≥n alimenticia</button>

          <div id="contenidoBeneficiario" style="margin-top: 20px;"></div>
        `;

        document.getElementById('contenidoAnexos').innerHTML = contenido;
      }

      function mostrarBeneficiario() {
        const contenedor = document.getElementById('contenidoBeneficiario');
        contenedor.innerHTML = `
          <h4>Verificaci√≥n de Beneficiario</h4>
          <label for="cedulaRuc">Ingrese C√©dula:</label>
          <input type="text" id="cedulaRuc" placeholder="Ej. 0102030405" maxlength="10"/>
          <button onclick="verificarBeneficiario()">Verificar</button>
          <div id="resultadoBeneficiario" style="margin-top: 10px;"></div>
        `;
      }

      // Objeto para almacenar resultados de verificaci√≥n
const resultadosVerificacion = {};

function verificarBeneficiario() {
    const input = document.getElementById('cedulaRuc').value.trim();
    const resultado = document.getElementById('resultadoBeneficiario');

    // Validar solo c√©dulas de 10 d√≠gitos
    if (!/^\d{10}$/.test(input)) {
        resultado.innerHTML = `<p style="color: red;">‚ùå Ingrese un n√∫mero v√°lido de C√©dula (10 d√≠gitos).</p>`;
        return;
    }

    // Verificar si ya se ha consultado este n√∫mero de c√©dula
    if (resultadosVerificacion[input]) {
        // Si ya existe un resultado, mostrarlo
        resultado.innerHTML = resultadosVerificacion[input];
        return;
    }

    // Simulaci√≥n de verificaci√≥n de beneficiario
    const esBeneficiario = Math.random() < 0.5;
    const mensaje = esBeneficiario
        ? `<p style="color: green;">‚úÖ El n√∫mero ingresado S√ç es beneficiario de pensi√≥n alimenticia.</p>`
        : `<p style="color: orange;">‚ùå El n√∫mero ingresado NO es beneficiario de pensi√≥n alimenticia.</p>`;

    // Almacenar el resultado en el objeto
    resultadosVerificacion[input] = mensaje;

    // Mostrar resultado
    resultado.innerHTML = mensaje;
}




        //FACTURACI√ìN

        

      // Facturaci√≥n


      function mostrarFacturacionFisica() {
        const contenedor = document.getElementById("facturacionFisica").style.display = "block";
        document.getElementById("facturacionElectronica").style.display = "none";

        contenedor.style.display = "block";
        contenedor.innerHTML = `
          <h2>Facturaci√≥n F√≠sica - Simulador SRI</h2>
          <form id="formFacturaFisica">
            <h4>Datos del Emisor</h4>
            <input type="text" placeholder="Raz√≥n Social" id="emisor" required><br>
            <input type="text" placeholder="RUC" id="rucEmisor" required><br>
            <input type="text" placeholder="Direcci√≥n" id="direccionEmisor" required><br>

            <h4>Datos del Cliente</h4>
            <input type="text" placeholder="Nombre del Cliente" id="cliente" required><br>
            <input type="text" placeholder="C√©dula/RUC Cliente" id="rucCliente" required><br>

            <h4>Detalles de la Factura</h4>
            <input type="text" placeholder="Descripci√≥n del Producto o Servicio" id="detalle" required><br>
            <input type="number" placeholder="Cantidad" id="cantidad" required><br>
            <input type="number" placeholder="Precio Unitario" id="precio" required><br>

            <button type="button" onclick="generarFacturaFisica()">üìù Generar Factura</button>
          </form>
        `;
      }


      // Generador simple de n√∫mero de factura
      function generarNumeroFactura() {
        const aleatorio = Math.floor(Math.random() * 1000000).toString().padStart(6, "0");
        return `001-001-${aleatorio}`;
      }

      // Funci√≥n para generar descarga de archivo .txt
      function descargarTxt(nombreArchivo, contenido) {
        const blob = new Blob([contenido], { type: "text/plain" });
        const enlace = document.createElement("a");
        enlace.href = URL.createObjectURL(blob);
        enlace.download = nombreArchivo;
        enlace.click();
      }


      function mostrarFacturacionFisica() {
        document.getElementById("facturacionFisica").style.display = "block";
        document.getElementById("facturacionElectronica").style.display = "none";
      }

      function mostrarFacturacionElectronica() {
        document.getElementById("facturacionFisica").style.display = "none";
        document.getElementById("facturacionElectronica").style.display = "block";
      }

      function generarNumeroFactura() {
        return `001-001-${Math.floor(Math.random() * 1000000).toString().padStart(6, "0")}`;
      }

      function descargarTxt(nombreArchivo, contenido) {
        const blob = new Blob([contenido], { type: "text/plain" });
        const enlace = document.createElement("a");
        enlace.href = URL.createObjectURL(blob);
        enlace.download = nombreArchivo;
        enlace.click();
      }

      // Factura F√≠sica
      function generarFacturaFisica() {
    const emisor = document.getElementById("emisor").value.trim();
    const rucEmisor = document.getElementById("rucEmisor").value.trim();
    const direccionEmisor = document.getElementById("direccionEmisor").value.trim();
    const cliente = document.getElementById("cliente").value.trim();
    const rucCliente = document.getElementById("rucCliente").value.trim();
    const detalle = document.getElementById("detalle").value.trim();
    const cantidad = parseInt(document.getElementById("cantidad").value);
    const precio = parseFloat(document.getElementById("precio").value);

    // Validaciones
    if (!emisor || !rucEmisor || !direccionEmisor || !cliente || !rucCliente || !detalle || isNaN(cantidad) || isNaN(precio)) {
        alert("Por favor, complete todos los campos requeridos.");
        return;
    }

    if (!/^[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±\s]+$/.test(cliente)) {
        alert("El nombre del cliente solo debe contener letras y espacios.");
        return;
    }

    if (!/^\d{13}$/.test(rucEmisor) || !rucEmisor.endsWith("001")) {
        alert("El RUC del emisor debe tener 13 d√≠gitos y terminar en 001.");
        return;
    }

    if (!/^\d{13}$/.test(rucCliente) || !rucCliente.endsWith("001")) {
        alert("El RUC del cliente debe tener 13 d√≠gitos y terminar en 001.");
        return;
    }

    if (!Number.isInteger(cantidad) || cantidad <= 0) {
        alert("La cantidad debe ser un n√∫mero positivo.");
        return;
    }

    if (precio <= 0) {
        alert("El precio debe ser un n√∫mero positivo.");
        return;
    }

    const subtotal = cantidad * precio;
    const iva = subtotal * 0.12;
    const total = subtotal + iva;
    const fecha = new Date().toLocaleDateString();
    const numeroFactura = generarNumeroFactura();
    const numAutorizacion = Math.floor(Math.random() * 99999999999999999999).toString().padStart(19, "0");

    // Contenido de la autorizaci√≥n
    const contenidoAutorizacion = `
      AUTORIZACI√ìN SRI
      -------------------------------
      RUC: ${rucEmisor}
      N√∫mero de autorizaci√≥n: ${numAutorizacion}
      Factura No.: ${numeroFactura}
      Fecha de autorizaci√≥n: ${fecha}
      -------------------------------
      Este archivo es v√°lido como constancia de autorizaci√≥n
    `;

    // Contenido de la factura
    const contenidoFactura = `
      FACTURA F√çSICA SRI SIMULADA
      ------------------------------------------------
      Emisor: ${emisor}
      RUC: ${rucEmisor}
      Direcci√≥n: ${direccionEmisor}
      Factura No.: ${numeroFactura}
      Autorizaci√≥n SRI: ${numAutorizacion}
      Fecha: ${fecha}

      Cliente: ${cliente}
      CI/RUC: ${rucCliente}

      ------------------------------------------------
      Detalle: ${detalle}
      Cantidad: ${cantidad}
      Precio Unitario: $${precio.toFixed(2)}
      Subtotal: $${subtotal.toFixed(2)}
      IVA 12%: $${iva.toFixed(2)}
      Total: $${total.toFixed(2)}
      ------------------------------------------------
      "Este documento es v√°lido para efectos tributarios"
    `;

    descargarTxt("autorizacion_sri.txt", contenidoAutorizacion);
    descargarTxt("factura_fisica.txt", contenidoFactura);
}


      // Factura Electr√≥nica
 function generarFacturaElectronica() {
    const emisor = document.getElementById("emisorE").value.trim();
    const rucEmisor = document.getElementById("rucEmisorE").value.trim();
    const direccionEmisor = document.getElementById("direccionEmisorE").value.trim();
    const cliente = document.getElementById("clienteE").value.trim();
    const rucCliente = document.getElementById("rucClienteE").value.trim();
    const detalle = document.getElementById("detalleE").value.trim();
    const cantidad = parseInt(document.getElementById("cantidadE").value);
    const precio = parseFloat(document.getElementById("precioE").value);

    // Validaciones
    if (!emisor || !rucEmisor || !direccionEmisor || !cliente || !rucCliente || !detalle || isNaN(cantidad) || isNaN(precio)) {
        alert("Por favor, complete todos los campos requeridos.");
        return;
    }

    if (!/^[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±\s]+$/.test(cliente)) {
        alert("El nombre del cliente solo debe contener letras y espacios.");
        return;
    }

    if (!/^\d{13}$/.test(rucEmisor) || !rucEmisor.endsWith("001")) {
        alert("El RUC del emisor debe tener 13 d√≠gitos y terminar en 001.");
        return;
    }

    if (!/^\d{13}$/.test(rucCliente) || !rucCliente.endsWith("001")) {
        alert("El RUC del cliente debe tener 13 d√≠gitos y terminar en 001.");
        return;
    }

    if (!Number.isInteger(cantidad) || cantidad <= 0) {
        alert("La cantidad debe ser un n√∫mero positivo.");
        return;
    }

    if (precio <= 0) {
        alert("El precio debe ser un n√∫mero positivo.");
        return;
    }

    const subtotal = cantidad * precio;
    const iva = subtotal * 0.12;
    const total = subtotal + iva;

    const fecha = new Date().toISOString().split('T')[0];
    const numeroFactura = generarNumeroFactura();
    const claveAcceso = Math.floor(10000000000000000000000000000000000000 + Math.random() * 90000000000000000000000000000000000000).toString();

    const xml = `
      <factura id="comprobante" version="1.1.0">
        <infoTributaria>
          <razonSocial>${emisor}</razonSocial>
          <ruc>${rucEmisor}</ruc>
          <claveAcceso>${claveAcceso}</claveAcceso>
          <codDoc>01</codDoc>
          <estab>001</estab>
          <ptoEmi>001</ptoEmi>
          <secuencial>${numeroFactura.split('-')[2]}</secuencial>
          <dirMatriz>${direccionEmisor}</dirMatriz>
        </infoTributaria>
        <infoFactura>
          <fechaEmision>${fecha}</fechaEmision>
          <dirEstablecimiento>${direccionEmisor}</dirEstablecimiento>
          <razonSocialComprador>${cliente}</razonSocialComprador>
          <identificacionComprador>${rucCliente}</identificacionComprador>
          <totalSinImpuestos>${subtotal.toFixed(2)}</totalSinImpuestos>
          <totalConImpuestos>
            <totalImpuesto>
              <codigo>2</codigo>
              <codigoPorcentaje>2</codigoPorcentaje>
              <baseImponible>${subtotal.toFixed(2)}</baseImponible>
              <valor>${iva.toFixed(2)}</valor>
            </totalImpuesto>
          </totalConImpuestos>
          <importeTotal>${total.toFixed(2)}</importeTotal>
        </infoFactura>
        <detalles>
          <detalle>
            <descripcion>${detalle}</descripcion>
            <cantidad>${cantidad}</cantidad>
            <precioUnitario>${precio.toFixed(2)}</precioUnitario>
            <precioTotalSinImpuesto>${subtotal.toFixed(2)}</precioTotalSinImpuesto>
          </detalle>
        </detalles>
      </factura>
    `;

    const autorizacion = `
      AUTORIZACI√ìN SRI - FACTURACI√ìN ELECTR√ìNICA
      --------------------------------------------
      RUC del Emisor: ${rucEmisor}
      Raz√≥n Social: ${emisor}
      N√∫mero de Factura: ${numeroFactura}
      Clave de Acceso: ${claveAcceso}
      Fecha de Autorizaci√≥n: ${fecha}
      Estado: AUTORIZADO
      --------------------------------------------
      Este documento sirve como constancia de autorizaci√≥n electr√≥nica por el SRI
    `;

    descargarTxt("autorizacion_electronica.txt", autorizacion);
    descargarTxt("factura_electronica.xml", xml);
}



//=======================================  VEHICULO  ===============================================


const marcasModelos = {
  "Chevrolet": ["Aveo", "Spark GT", "Tracker", "Onix"],
  "Toyota": ["Corolla", "Yaris", "RAV4", "Hilux"],
  "Ford": ["Fiesta", "Focus", "Escape", "Explorer"],
  "Kia": ["Rio", "Sportage", "Cerato", "Seltos"]
};

const datosGuardados = {};
const pagosRealizados = {};
const pagosConfirmados = new Set();

// Nombres aleatorios
const nombresHombres = ["Juan", "Carlos", "Luis", "Miguel", "Jos√©", "Andr√©s"];
const apellidosHombres = ["P√©rez", "Garc√≠a", "Rodr√≠guez", "L√≥pez", "Mart√≠nez"];
const nombresMujeres = ["Mar√≠a", "Luisa", "Ana", "Carla", "Sof√≠a", "Elena"];
const apellidosMujeres = ["G√≥mez", "D√≠az", "Fern√°ndez", "Morales", "Castro"];

let ultimoDatoIngresado = '';

// Funciones principales
function mostrarConsultaVehiculo(tipo) {
  const placeholder = tipo === 'placa' ? 
    'Ingrese Placa, RAMV o CPN (Ej: ABC1234)' : 
    'Ingrese C√≥digo de Chasis (17 caracteres)';

  document.getElementById('contenidoVehiculo').innerHTML = `
    <input type="text" id="inputDato" placeholder="${placeholder}" class="input-text" />
    <button onclick="validarDato('${tipo}')" class="btn-validar">Validar</button>
    <p id="mensajeValidacion"></p>
    <div id="infoVehiculo"></div>
    <div class="pago-container">
      <div id="infoPagoIzq" class="pago-card" style="float: left; width: 48%;"></div>
      <div id="metodosPagoDer" class="pago-card" style="float: right; width: 48%;"></div>
    </div>
    <div style="clear: both;"></div>
    <div id="tablaReportes"></div>
    <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
      <button onclick="mostrarPagosRealizados()" class="btn-validar">Ver Reportes de Pago</button>
    </div>
  `;

  document.getElementById('seccionPagosRealizados').innerHTML = '';
}


function validarDato(tipo) {
  const input = document.getElementById('inputDato').value.trim().toUpperCase();
  ultimoDatoIngresado = input;
  const mensaje = document.getElementById('mensajeValidacion');

  const regexPlaca = /^[A-Z]{3}\d{3,4}$/;
  const regexChasis = /^[A-Z0-9]{17}$/;

  if ((tipo === 'placa' && !regexPlaca.test(input)) || (tipo === 'chasis' && !regexChasis.test(input))) {
    mensaje.textContent = tipo === 'placa' ?
      '‚ùå Dato inv√°lido. Formato: 3 letras y 3-4 n√∫meros (Ej: ABC1234)' :
      '‚ùå C√≥digo inv√°lido. Debe tener 17 caracteres y n√∫meros';
    mensaje.className = 'mensaje-error';
    return;
  }

  mensaje.textContent = tipo === 'placa' ? '‚úÖ Placa v√°lida' : '‚úÖ C√≥digo de chasis v√°lido';

  mensaje.className = 'mensaje-exito';

  if (!datosGuardados[input]) {
    datosGuardados[input] = generarDatosAleatorios(tipo, input);
  }
  renderizarDatos(datosGuardados[input], tipo, input);
}

function generarDatosAleatorios(tipo, input) {
  const marcas = Object.keys(marcasModelos);
  const marca = marcas[Math.floor(Math.random() * marcas.length)];
  const modelo = marcasModelos[marca][Math.floor(Math.random() * 4)];
  const anio = Math.floor(Math.random() * (2024 - 2005 + 1)) + 2005;
  const rubros = ['Multa', 'Impuesto', 'Revisi√≥n t√©cnica', 'Parqueo indebido', 'Otros cargos'];
  const cantidad = Math.floor(Math.random() * 3) + 1;

  let reportes = [], total = 0;
  for (let i = 0; i < cantidad; i++) {
    const rubro = rubros[Math.floor(Math.random() * rubros.length)];
    const valor = Math.floor(Math.random() * (184 - 34 + 1)) + 34;
    total += valor;
    reportes.push({ 
      rubro, 
      fecha: generarFechaAleatoria(), 
      valor, 
      pagado: false 
    });
  }

  return { 
    marca, 
    modelo, 
    anio, 
    anioPago: new Date().getFullYear(), 
    reportes, 
    total, 
    datoIngresado: input 
  };
}

function renderizarDatos(data, tipo, input) {
  const infoVehiculoHTML = `
    <h3>Informaci√≥n del Veh√≠culo</h3>
    <p><strong>${tipo === 'placa' ? 'Placa' : 'Chasis'}:</strong> ${input}</p>
    <p><strong>Marca:</strong> ${data.marca}</p>
    <p><strong>Modelo:</strong> ${data.modelo}</p>
    <p><strong>A√±o:</strong> ${data.anio}</p>
  `;

  const infoPagoHTML = `
    <strong style="color: blue;">√öLTIMO PAGO</strong><br>
    A√±o: ${data.anioPago}
  `;

  let filas = data.reportes.map(r => `
    <tr>
      <td>${r.rubro}</td>
      <td>${r.fecha}</td>
      <td>$${r.valor}</td>
      <td style="color: ${r.pagado ? 'green' : 'red'}">
        ${r.pagado ? '‚úì Pagado' : '‚úó Pendiente'}
      </td>
    </tr>
  `).join('');

  const keyPago = `${input}_${data.anioPago}`;
  const pagoYaRealizado = pagosConfirmados.has(keyPago);

  const metodosPagoHTML = `
    <h4>M√âTODOS DE PAGO</h4>
    <p>Total: <strong>$${data.total}</strong></p>
    <div class="botones-pago">
      <button ${pagoYaRealizado ? 'disabled' : ''} onclick="abrirModalPagoTarjeta('${input}')">
        Pagar con Tarjeta
      </button>
      <button ${pagoYaRealizado ? 'disabled' : ''} onclick="generarBoleto('${input}', '${data.total}')">
        Generar Boleto
      </button>
    </div>
    ${pagoYaRealizado ? '<p class="pago-realizado">Pago ya realizado</p>' : ''}
  `;

  document.getElementById('infoVehiculo').innerHTML = infoVehiculoHTML;
  document.getElementById('infoPagoIzq').innerHTML = infoPagoHTML;
  document.getElementById('metodosPagoDer').innerHTML = metodosPagoHTML;
  document.getElementById('tablaReportes').innerHTML = `
    <h2>Reportes de pago del veh√≠culo</h2>
    <table class="tabla-reportes">
      <thead>
        <tr>
          <th>Rubro</th>
          <th>Fecha</th>
          <th>Valor</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        ${filas}
        <tr class="total-row">
          <td colspan="3"><strong>Total a Cancelar</strong></td>
          <td><strong>$${data.total}</strong></td>
        </tr>
      </tbody>
    </table>
  `;
}

function abrirModalPagoTarjeta(placa) {
    const pago = datosGuardados[placa];
    if (!pago) {
        mostrarAlerta('Debe validar primero la placa');
        return;
    }

    const modal = document.getElementById('modalPagoTarjeta');
    modal.innerHTML = `
        <div class="modal-contenido">
            <span class="cerrar-modal" onclick="cerrarModalPagoTarjeta()">&times;</span>
            <h2>Pago con Tarjeta</h2>
            <p class="total-pago">Total a pagar: $${pago.total}</p>
            
            <div class="form-group">
                <label for="inputNumeroTarjeta">N√∫mero de Tarjeta</label>
                <input type="text" id="inputNumeroTarjeta" placeholder="1234 5678 9012 3456" maxlength="16">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="inputFechaVencimiento">Vencimiento (MM/AA)</label>
                    <input type="text" id="inputFechaVencimiento" placeholder="MM/AA">
                </div>
                
                <div class="form-group">
                    <label for="inputCodigoSeguridad">CVV</label>
                    <input type="password" id="inputCodigoSeguridad" placeholder="123" maxlength="3">
                </div>
            </div>
            
            <div class="botones-accion">
                <button onclick="procesarPagoConTarjeta('${placa}')" class="btn-primario">Confirmar Pago</button>
                <button onclick="cerrarModalPagoTarjeta()" class="btn-secundario">Cancelar</button>
            </div>
        </div>
    `;
    
    modal.style.display = 'block';
}

function procesarPagoConTarjeta(placa) {
    const pago = datosGuardados[placa];
    if (!verificarPagoUnico(placa)) {
        mostrarAlerta('Ya se realiz√≥ el pago para esta placa');
        return;
    }

    if (!pago) {
        mostrarAlerta('No se encontr√≥ informaci√≥n del veh√≠culo');
        return false;
    }

    const numeroTarjeta = document.getElementById('inputNumeroTarjeta')?.value.replace(/\s/g, '') || '';
    const fechaVenc = document.getElementById('inputFechaVencimiento')?.value || '';
    const codigoSeguridad = document.getElementById('inputCodigoSeguridad')?.value || '';

    // Acumular mensajes de error
    let mensajesError = [];

    // Validaciones de campos
    if (!/^\d{16}$/.test(numeroTarjeta)) {
        mensajesError.push(`‚ùå N√∫mero de tarjeta inv√°lido\nSe ingres√≥: ${numeroTarjeta}\nDebe tener exactamente 16 d√≠gitos.`);
    } else if (!/^\d+$/.test(numeroTarjeta)) {
        mensajesError.push(`‚ùå N√∫mero de tarjeta inv√°lido\nSe ingres√≥: ${numeroTarjeta}\nSolo se permiten d√≠gitos.`);
    }

    const fechaMatch = fechaVenc.match(/^(\d{2})\/(\d{2})$/);
    if (!fechaMatch) {
        mensajesError.push(`‚ùå Formato de fecha inv√°lido\nSe ingres√≥: ${fechaVenc}\nUse el formato MM/AA.`);
    } else {
        const [mes, a√±o] = fechaMatch.slice(1).map(Number);
        const hoy = new Date();
        const a√±oActual = hoy.getFullYear() % 100;
        const mesActual = hoy.getMonth() + 1;

        if (mes < 1 || mes > 12) {
            mensajesError.push(`‚ùå Mes de vencimiento inv√°lido\nSe ingres√≥: ${mes}\nDebe estar entre 01 y 12.`);
        }
        if (a√±o < a√±oActual || (a√±o === a√±oActual && mes < mesActual)) {
            mensajesError.push(`‚ùå La tarjeta est√° vencida\nFecha ingresada: ${fechaVenc}\nVerifique la fecha de vencimiento.`);
        }
    }

    if (!/^\d{3}$/.test(codigoSeguridad)) {
        mensajesError.push(`‚ùå C√≥digo de seguridad inv√°lido\nSe ingres√≥: ${codigoSeguridad}\nDebe tener exactamente 3 d√≠gitos.`);
    } else if (!/^\d+$/.test(codigoSeguridad)) {
        mensajesError.push(`‚ùå C√≥digo de seguridad inv√°lido\nSe ingres√≥: ${codigoSeguridad}\nSolo se permiten d√≠gitos.`);
    }

    // Si hay errores, mostrar todos juntos
    if (mensajesError.length > 0) {
        alert('ERRORES EN EL FORMULARIO:\n\n' + mensajesError.join('\n\n')); // Unir mensajes con salto de l√≠nea
        return false;
    }

    // Procesar pago (simulado)
    mostrarAlerta('Procesando pago...', 'info');
    
    setTimeout(() => {
        // Solo si llegamos aqu√≠, todas las validaciones pasaron
        try {
            // Confirmar el pago y actualizar el estado del reporte
            confirmarPago(placa, 'Tarjeta');
            
            // Mostrar mensaje de √©xito
            mostrarAlerta('¬°Pago exitoso!', 'success');

            // Generar comprobante opcional
            if (confirm('¬øDesea descargar el comprobante?')) {
                generarBoletoPagoTarjeta(placa, pago.total);
            }
            
            cerrarModalPagoTarjeta();
            // Actualizar vista
            renderizarDatos(pago, 'placa', placa);
        } catch (error) {
            console.error('Error al procesar pago:', error);
            mostrarAlerta('Error al procesar el pago', 'error');
        }
    }, 500);

    return true;
}



function confirmarPago(placa, metodo = 'Tarjeta') {
    const pago = datosGuardados[placa];
    if (!pago) {
        mostrarAlerta('No se encontr√≥ informaci√≥n del veh√≠culo', 'error');
        return false;
    }
    
    const keyPago = `${placa}_${pago.anioPago}`;
    if (pagosConfirmados.has(keyPago)) {
        mostrarAlerta('Este veh√≠culo ya tiene un pago registrado', 'warning');
        return false;
    }
    
    pagosConfirmados.add(keyPago);
    
    // Generar datos del contribuyente
    const esHombre = Math.random() < 0.5;
    const nombres = esHombre ? nombresHombres : nombresMujeres;
    const apellidos = esHombre ? apellidosHombres : apellidosMujeres;
    const nombreCompleto = `${nombres[Math.floor(Math.random() * nombres.length)]} ${apellidos[Math.floor(Math.random() * apellidos.length)]}`;
    
    // Marcar reportes como pagados
    const fechaPago = new Date().toLocaleDateString();
    pago.reportes.forEach(reporte => {
        reporte.pagado = true;
        reporte.fechaPago = fechaPago;
    });
    
    // Registrar pago
    if (!pagosRealizados[placa]) pagosRealizados[placa] = [];
    pagosRealizados[placa].push({
        anio: pago.anioPago,
        datos: pago.reportes,
        total: pago.total,
        metodoPago: metodo,
        nombreCompleto: nombreCompleto,
        cedula: generarCedulaAleatoria(),
        datoIngresado: placa,
        fechaPago: fechaPago,
        idTransaccion: Date.now() // Generar un ID √∫nico basado en la fecha
    });
    
    // Actualizar UI
    renderizarDatos(pago, 'placa', placa);
    mostrarAlerta('¬°Pago realizado con √©xito!', 'success'); // Notificaci√≥n de √©xito
    return true;
}

// Nueva funci√≥n para generar el boleto al pagar con tarjeta
function generarBoletoPagoTarjeta(placa, total) {
    const contenido = `BOLETO DE PAGO TARJETA\n\nPlaca: ${placa}\nFecha: ${new Date().toLocaleDateString()}\nTotal: $${total}\nCod. Barras: ${Math.random().toString(36).substr(2, 20).toUpperCase()}\nVencimiento: ${new Date(Date.now() + 86400000 * 5).toLocaleDateString()}`;
    
    // Crear link de descarga (simulado)
    const enlace = document.createElement('a');
    enlace.href = URL.createObjectURL(new Blob([contenido], { type: 'text/plain' }));
    enlace.download = `BoletoPagoTarjeta_${placa}.txt`;
    document.body.appendChild(enlace);
    enlace.click();
    document.body.removeChild(enlace);
}

function cerrarModalPagoTarjeta() {
    document.getElementById('modalPagoTarjeta').style.display = 'none';
}

function mostrarAlerta(mensaje, tipo = 'error') {
    const alerta = document.createElement('div');
    alerta.className = `alerta alerta-${tipo}`;
    alerta.textContent = mensaje;
    
    document.body.appendChild(alerta);
    
    setTimeout(() => {
        alerta.classList.add('alerta-salir');
        setTimeout(() => document.body.removeChild(alerta), 300);
    }, 3000);
}

function generarFechaAleatoria() {
    const fecha = new Date();
    fecha.setMonth(fecha.getMonth() - Math.floor(Math.random() * 12));
    return fecha.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    }).replace(/\//g, '-');
}

function generarCedulaAleatoria() {
    const provincia = String(Math.floor(Math.random() * 24) + 1).padStart(2, '0');
    const tercerDigito = Math.floor(Math.random() * 6);
    const digitos = [provincia, tercerDigito];
    
    for (let i = 0; i < 6; i++) {
        digitos.push(Math.floor(Math.random() * 10));
    }
    
    // Calcular d√≠gito verificador
    const coeficientes = [2, 1, 2, 1, 2, 1, 2, 1, 2];
    let suma = 0;
    
    for (let i = 0; i < 9; i++) {
        let valor = digitos[i] * coeficientes[i];
        suma += (valor > 9) ? valor - 9 : valor;
    }
    
    const verificador = (suma % 10 === 0) ? 0 : 10 - (suma % 10);
    digitos.push(verificador);
    
    return digitos.join('');
}

function generarBoleto(placa, total) {
    if (!verificarPagoUnico(placa)) {
        mostrarAlerta('Ya se realiz√≥ el pago para esta placa');
        return;
    }

    confirmarPago(placa, 'Boleto Bancario');
    mostrarAlerta('Boleto generado con √©xito', 'success');
    
    const contenido = `BOLETO DE PAGO\n\nPlaca: ${placa}\nFecha: ${new Date().toLocaleDateString()}\nTotal: $${total}\nCod. Barras: ${Math.random().toString(36).substr(2, 20).toUpperCase()}\nVencimiento: ${new Date(Date.now() + 86400000 * 5).toLocaleDateString()}`;
    
    // Crear link de descarga (simulado)
    const enlace = document.createElement('a');
    enlace.href = URL.createObjectURL(new Blob([contenido], { type: 'text/plain' }));
    enlace.download = `BoletoPago_${placa}.txt`;
    enlace.click();
}

function verificarPagoUnico(placa) {
    const pago = datosGuardados[placa];
    if (!pago) return false;
    return !pagosConfirmados.has(`${placa}_${pago.anioPago}`);
}

function mostrarPagosRealizados() {
    const seccionPagos = document.getElementById('seccionPagosRealizados');
    const contenidoPrincipal = document.getElementById('contenidoVehiculo');
    
    // Ocultar la secci√≥n de consulta
    contenidoPrincipal.style.display = 'none';
    
    // Mostrar y preparar la secci√≥n de pagos realizados
    seccionPagos.style.display = 'block';
    seccionPagos.innerHTML = '';
    
    if (!ultimoDatoIngresado || !pagosRealizados[ultimoDatoIngresado]) {
        seccionPagos.innerHTML = `
            <div class="sin-pagos">
                <h2>Reportes de Pago</h2>
                <p>No existen pagos registrados para este veh√≠culo</p>
            </div>
        `;
        return;
    }

    const pagos = pagosRealizados[ultimoDatoIngresado];
    
    // Crear encabezado con bot√≥n para volver
    const encabezado = document.createElement('div');
    encabezado.className = 'encabezado-reportes';
    encabezado.innerHTML = `
        <h2>Reportes de Pago - Placa: ${ultimoDatoIngresado}</h2>
    `;
    seccionPagos.appendChild(encabezado);
    
    // Crear contenedor para los reportes
    const contenedorReportes = document.createElement('div');
    contenedorReportes.className = 'lista-reportes';
    
    // Ordenar los pagos por fecha (m√°s recientes primero)
    pagos.sort((a, b) => new Date(b.fechaPago) - new Date(a.fechaPago));
    
    // Generar los elementos de cada pago
    pagos.forEach((pago, index) => {
        const rubrosPagados = pago.datos.filter(r => r.pagado).length;
        const porcentajePagado = Math.round((rubrosPagados / pago.datos.length) * 100);
        
        const reporteElement = document.createElement('div');
        reporteElement.className = 'item-reporte';
        reporteElement.innerHTML = `
            <div class="info-reporte">
                <div class="encabezado-reporte">
                    <span class="numero-transaccion">Transacci√≥n #${pago.idTransaccion}</span>
                    <span class="fecha-pago">${pago.fechaPago}</span>
                </div>
                
                <div class="detalles-reporte">
                    <div class="info-columna">
                        <span class="etiqueta">M√©todo de pago</span>
                        <span class="valor metodo-pago">
                            <i class="fas ${pago.metodoPago === 'Tarjeta' ? 'fa-credit-card' : 'fa-file-invoice-dollar'}"></i>
                            ${pago.metodoPago}
                        </span>
                    </div>
                    
                    <div class="info-columna">
                        <span class="etiqueta">Rubros pagados</span>
                        <div class="barra-progreso">
                            <div class="progreso" style="width: ${porcentajePagado}%"></div>
                            <span class="texto-progreso">${rubrosPagados}/${pago.datos.length} (${porcentajePagado}%)</span>
                        </div>
                    </div>
                    
                    <div class="info-columna total">
                        <span class="etiqueta">Total pagado</span>
                        <span class="valor monto">$${pago.total.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <div class="acciones-reporte">
                <button onclick="verDetallesPago('${ultimoDatoIngresado}', ${index})" class="btn-detalles">
                    Ver Detalles
                </button>
            </div>
        `;
        
        contenedorReportes.appendChild(reporteElement);
    });
    
    seccionPagos.appendChild(contenedorReportes);
    
    // Agregar estilos din√°micamente
    const estilo = document.createElement('style');
    estilo.textContent = `
        .sin-pagos {
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .sin-pagos h2 {
            color: #6c757d;
        }
        
        .btn-volver {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        .btn-volver:hover {
            background: #5a6268;
        }
        
        .encabezado-reportes {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .lista-reportes {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .item-reporte {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
        }
        
        .info-reporte {
            flex: 1;
        }
        
        .encabezado-reporte {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .numero-transaccion {
            font-weight: bold;
            color: #495057;
        }
        
        .fecha-pago {
            color: #6c757d;
        }
        
        .detalles-reporte {
            display: flex;
            gap: 2rem;
        }
        
        .info-columna {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .etiqueta {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .valor {
            font-size: 1rem;
        }
        
        .metodo-pago {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #007bff;
        }
        
        .barra-progreso {
            width: 150px;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .progreso {
            height: 100%;
            background: #17a2b8;
        }
        
        .texto-progreso {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
        }
        
        .total .valor {
            font-weight: bold;
            color: #28a745;
        }
        
        .acciones-reporte {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .btn-detalles {
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #17a2b8;
            color: white;
        }
        
        .btn-detalles:hover {
            background: #138496;
        }
    `;
    document.head.appendChild(estilo);
}

function volverAConsulta() {
    const seccionPagos = document.getElementById('seccionPagosRealizados');
    const contenidoPrincipal = document.getElementById('contenidoVehiculo');
    
    seccionPagos.style.display = 'none';
    contenidoPrincipal.style.display = 'block';
}


function verDetallesPago(placa, index) {
    const pago = pagosRealizados[placa][index];
    const modal = document.createElement('div');
    modal.className = 'modal-detalles';
    modal.innerHTML = `
        <div class="modal-contenido">
            <div class="modal-header">
                <h2>Detalles del Pago</h2>
                <span class="cerrar-modal" onclick="document.body.removeChild(this.parentNode.parentNode)">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="resumen-pago">
                    <div class="resumen-item">
                        <span class="resumen-etiqueta">Placa:</span>
                        <span class="resumen-valor">${placa}</span>
                    </div>
                    <div class="resumen-item">
                        <span class="resumen-etiqueta">Fecha de Pago:</span>
                        <span class="resumen-valor">${pago.fechaPago}</span>
                    </div>
                    <div class="resumen-item">
                        <span class="resumen-etiqueta">M√©todo:</span>
                        <span class="resumen-valor metodo-pago">
                            <i class="fas ${pago.metodoPago === 'Tarjeta' ? 'fa-credit-card' : 'fa-file-invoice-dollar'}"></i>
                            ${pago.metodoPago}
                        </span>
                    </div>
                    <div class="resumen-item">
                        <span class="resumen-etiqueta">Total:</span>
                        <span class="resumen-valor total">$${pago.total.toFixed(2)}</span>
                    </div>
                    <div class="resumen-item">
                        <span class="resumen-etiqueta">ID Transacci√≥n:</span>
                        <span class="resumen-valor">${pago.idTransaccion}</span>
                    </div>
                </div>
                
                <h3>Rubros Pagados</h3>
                <table class="tabla-detalles">
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th>Fecha</th>
                            <th>Valor</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pago.datos.map(r => `
                            <tr>
                                <td>${r.rubro}</td>
                                <td>${r.fecha}</td>
                                <td>$${r.valor}</td>
                                <td class="${r.pagado ? 'pagado' : 'pendiente'}">
                                    ${r.pagado ? 'Pagado' : 'Pendiente'}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <div class="modal-footer">
                <button onclick="generarComprobante('${placa}', ${index})" class="btn-generar">
                    <i class="fas fa-file-pdf"></i> Generar Comprobante
                </button>
                <button onclick="document.body.removeChild(this.parentNode.parentNode.parentNode)" class="btn-cerrar">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    `;
    
    // Estilos para el modal
    const estiloModal = document.createElement('style');
    estiloModal.textContent = `
        .modal-detalles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-contenido {
            background: white;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 1rem;
            background: #343a40;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cerrar-modal {
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .cerrar-modal:hover {
            color: #ddd;
        }
        
        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .resumen-pago {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .resumen-item {
            display: flex;
            flex-direction: column;
        }
        
        .resumen-etiqueta {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .resumen-valor {
            font-weight: 500;
        }
        
        .total {
            color: #28a745;
            font-weight: bold;
        }
        
        .metodo-pago {
            color: #007bff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tabla-detalles {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .tabla-detalles th {
            background: #343a40;
            color: white;
            padding: 0.75rem;
            text-align: left;
        }
        
        .tabla-detalles td {
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .pagado {
            color: #28a745;
            font-weight: bold;
        }
        
        .pendiente {
            color: #dc3545;
            font-weight: bold;
        }
        
        .modal-footer {
            padding: 1rem;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .btn-generar, .btn-cerrar {
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-generar {
            background: #dc3545;
            color: white;
        }
        
        .btn-generar:hover {
            background: #c82333;
        }
        
        .btn-cerrar {
            background: #6c757d;
            color: white;
        }
        
        .btn-cerrar:hover {
            background: #5a6268;
        }
    `;
    document.head.appendChild(estiloModal);
    
    document.body.appendChild(modal);
}

function generarComprobante(placa, index) {
    const pago = pagosRealizados[placa][index];
    
    // Crear contenido del comprobante
    let contenido = `
        COMPROBANTE DE PAGO\n\n
        Fecha: ${new Date().toLocaleDateString()}\n
        ID Transacci√≥n: ${pago.idTransaccion}\n
        Placa: ${placa}\n
        M√©todo de Pago: ${pago.metodoPago}\n
        Total Pagado: $${pago.total.toFixed(2)}\n\n
        Rubros:\n
    `;
    
    pago.datos.forEach(r => {
        contenido += `- ${r.rubro}: $${r.valor} (${r.pagado ? 'Pagado' : 'Pendiente'})\n`;
    });
    
    // Crear enlace de descarga
    const enlace = document.createElement('a');
    enlace.href = URL.createObjectURL(new Blob([contenido], { type: 'text/plain' }));
    enlace.download = `Comprobante_${placa}_${pago.idTransaccion}.txt`;
    enlace.click();
    
    mostrarAlerta('Comprobante generado con √©xito', 'success');
}

// Funci√≥n auxiliar para formatear fechas (si no existe)
function formatearFecha(fechaString) {
    if (!fechaString) return '';
    
    const opciones = { year: 'numeric', month: '2-digit', day: '2-digit' };
    return new Date(fechaString).toLocaleDateString('es-ES', opciones);
}

// Nueva funci√≥n para generar n√∫meros de tarjeta aleatorios (solo para simulaci√≥n)
function generarNumeroTarjeta() {
    let num = '';
    for (let i = 0; i < 16; i++) {
        if (i > 0 && i % 4 === 0) num += ' ';
        num += Math.floor(Math.random() * 10);
    }
    return num;
}




//======================================================================================================================


        // Simulaci√≥n de datos base (podr√≠as conectar con tus arrays reales m√°s adelante)
        // üü¶ Valores iniciales
        let datosSistema = {
          facturas: Math.floor(Math.random() * 3001) + 2000,
          anexos: Math.floor(Math.random() * 3001) + 2000,
          deudas: Math.floor(Math.random() * 3001) + 2000,
          reportesVehiculos: Math.floor(Math.random() * 3001) + 2000
        };

        function generarVariacionPorcentaje(valor) {
          const variacion = Math.floor(valor * 0.15);
          const cambio = Math.floor(Math.random() * (variacion + 1));
          const suma = Math.random() < 0.5 ? -cambio : cambio;
          return Math.max(0, valor + suma);
        }

        function obtenerDatosVariables() {
          return {
            facturas: generarVariacionPorcentaje(datosSistema.facturas),
            anexos: generarVariacionPorcentaje(datosSistema.anexos),
            deudas: generarVariacionPorcentaje(datosSistema.deudas),
            reportesVehiculos: generarVariacionPorcentaje(datosSistema.reportesVehiculos)
          };
        }

        let graficaSistema = null;
        let intervaloGrafica = null;

        function mostrarGrafica() {
          document.querySelectorAll('.modulo').forEach(m => m.classList.add('hidden'));
          document.getElementById('grafica').classList.remove('hidden');

          const ctx = document.getElementById('graficaSistema').getContext('2d');
          const datosIniciales = obtenerDatosVariables();

          graficaSistema = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: [
                'Facturas Generadas',
                'Anexos Procesados',
                'Deudas Registradas',
                'Reportes de Veh√≠culos'
              ],
              datasets: [{
                label: 'Cantidad total',
                data: [
                  datosIniciales.facturas,
                  datosIniciales.anexos,
                  datosIniciales.deudas,
                  datosIniciales.reportesVehiculos
                ],
                backgroundColor: ['#007bff88', '#28a74588', '#ffc10788', '#dc354588'],
                borderColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
              },
              plugins: {
                title: {
                  display: true,
                  text: 'Resumen General del Sistema'
                },
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            }
          });

          // Evita m√∫ltiples intervalos
          if (intervaloGrafica) clearInterval(intervaloGrafica);

          intervaloGrafica = setInterval(() => {
            const nuevosDatos = obtenerDatosVariables();
            const nuevosValores = [
              nuevosDatos.facturas,
              nuevosDatos.anexos,
              nuevosDatos.deudas,
              nuevosDatos.reportesVehiculos
            ];

            // üîÑ Actualiza solo los datos sin destruir la gr√°fica
            graficaSistema.data.datasets[0].data = nuevosValores;
            graficaSistema.update();
          }, 6000);
        }



      //===========================================================================================================================================0
      //=============================================================================== DEUDAS =================================================0
      //===========================================================================================================================================0

const registroDeudasPorCedula = {};
let deudasUsuario = [];

// Validaci√≥n simple de c√©dula ecuatoriana
function validarCedula(cedula) {
  // Verificar que la c√©dula tenga exactamente 10 d√≠gitos
  return /^\d{10}$/.test(cedula);
}

// --- FUNCIONES PARA CONSULTA DE DEUDAS ---

function mostrarConsultaDeudas() {
  document.getElementById("contenidoDeudas").innerHTML = `
    <h3>Consulta de Deudas</h3>
    <label>C√©dula:</label>
    <input type="text" id="cedulaConsulta" placeholder="Ej: 0102030405">
    <button onclick="validarConsultaDeudas()">Consultar</button>
    <div id="resultadoConsulta" style="margin-top: 10px;"></div>
  `;
  document.getElementById("btnPagarDeudas").disabled = true;
  document.getElementById("btnFacilidadesPago").disabled = true;
}

function validarConsultaDeudas() {
  const cedula = document.getElementById("cedulaConsulta").value.trim();
  const resultadoDiv = document.getElementById("resultadoConsulta");

  // Validar c√©dula
  if (!validarCedula(cedula)) {
    alert("C√©dula inv√°lida. Ingrese una c√©dula ecuatoriana v√°lida (10 d√≠gitos).");
    return;
  }

  // Consultar deudas
  if (registroDeudasPorCedula.hasOwnProperty(cedula)) {
    deudasUsuario = registroDeudasPorCedula[cedula];
  } else {
    const tieneDeuda = Math.random() < 0.6;
    deudasUsuario = tieneDeuda ? generarDeudasAleatorias() : [];
    registroDeudasPorCedula[cedula] = deudasUsuario;
  }

  // Mostrar resultados
  if (deudasUsuario.length === 0 || deudasUsuario.every(d => d.monto <= 0)) {
    resultadoDiv.innerHTML = `<p style="color:green;">No tiene deudas registradas para la c√©dula ${cedula}.</p>`;
    document.getElementById("btnPagarDeudas").disabled = true;
    document.getElementById("btnFacilidadesPago").disabled = true;
    return;
  }

  let html = `<p style="color:red;">Se encontraron ${deudasUsuario.length} deudas para la c√©dula ${cedula}:</p><ul>`;
  deudasUsuario.forEach(d => {
    html += `<li><strong>${d.descripcion}</strong> - $${d.monto.toFixed(2)} (ID: ${d.id})</li>`;
  });
  html += "</ul>";

  resultadoDiv.innerHTML = html;
  document.getElementById("btnPagarDeudas").disabled = false;
  document.getElementById("btnFacilidadesPago").disabled = false;
}

// --- FUNCIONES PARA GENERAR DEUDAS ALEATORIAS ---

function generarDeudasAleatorias() {
  const opcionesDeudas = [
    { id: "D001", descripcion: "Impuesto Renta 2024", montoMin: 200, montoMax: 800 },
    { id: "D002", descripcion: "Multa por declaraci√≥n tard√≠a", montoMin: 30, montoMax: 100 },
    { id: "D003", descripcion: "Contribuci√≥n solidaria", montoMin: 100, montoMax: 400 },
    { id: "D004", descripcion: "Intereses por mora", montoMin: 10, montoMax: 60 },
    { id: "D005", descripcion: "Recargo IVA", montoMin: 50, montoMax: 150 },
    { id: "D006", descripcion: "Multa ambiental", montoMin: 80, montoMax: 300 },
    { id: "D007", descripcion: "Tasa municipal", montoMin: 20, montoMax: 90 },
    { id: "D008", descripcion: "Mora servicio el√©ctrico", montoMin: 50, montoMax: 200 },
    { id: "D009", descripcion: "Servicio m√©dico privado", montoMin: 100, montoMax: 250 },
    { id: "D010", descripcion: "Pago internet domiciliario", montoMin: 40, montoMax: 120 }
  ];

  const cantidad = Math.random() < 0.65 ? Math.floor(Math.random() * 2) + 1 : 3;
  const copia = [...opcionesDeudas];
  const seleccionadas = [];

  for (let i = 0; i < cantidad; i++) {
    const index = Math.floor(Math.random() * copia.length);
    const deuda = copia.splice(index, 1)[0];
    const monto = Math.random() * (deuda.montoMax - deuda.montoMin) + deuda.montoMin;

    seleccionadas.push({
      id: deuda.id,
      descripcion: deuda.descripcion,
      monto: parseFloat(monto.toFixed(2))
    });
  }

  return seleccionadas;
}

// --- FUNCIONES PARA PAGAR DEUDAS ---
function mostrarPagoDeudas() {
  if (deudasUsuario.length === 0) {
    alert("No hay deudas registradas para pagar.");
    return;
  }

  let contenido = `
    <h3>Pagar Deudas</h3>
    <label>Selecciona la deuda a pagar:</label>
    <select id="selectDeudaPago">
      ${deudasUsuario.map(d => `<option value="${d.id}">${d.descripcion} - $${d.monto.toFixed(2)}</option>`).join('')}
    </select>

    <div style="margin-top:10px;">
      <button onclick="mostrarFormularioTarjeta()">Pago con Tarjeta</button>
      <button onclick="generarBoletinPagoEfectivo()">Pago en Efectivo</button>
    </div>

    <div id="mensajePago" style="margin-top:10px;"></div>
  `;

  document.getElementById("contenidoDeudas").innerHTML = contenido;
}

function mostrarFormularioTarjeta() {
  const deudaSelect = document.getElementById("selectDeudaPago");
  const deudaSeleccionada = deudaSelect.options[deudaSelect.selectedIndex].text;
  const deudaId = deudaSelect.value;
  const deuda = deudasUsuario.find(d => d.id === deudaId);

  const html = `
    <div id="modalTarjeta" style="display:block; background-color:white; padding:20px; border:1px solid #ccc; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000;">
      <h4>Datos de Tarjeta</h4>
      <label>N√∫mero de Tarjeta (16 d√≠gitos):</label>
      <input type="text" id="numeroTarjeta" maxlength="16" placeholder="Ej: 1234567812345678"><br>

      <label>Fecha de Vencimiento (MM/AA):</label>
      <input type="text" id="fechaVencimiento" placeholder="Ej: 12/27"><br>

      <label>C√≥digo de Seguridad (CVV - 3 d√≠gitos):</label>
      <input type="text" id="codigoSeguridad" maxlength="3" placeholder="Ej: 123"><br>

      <p><strong>Deuda seleccionada:</strong> ${deudaSeleccionada}</p>
      <p><strong>Monto a pagar:</strong> $${deuda.monto.toFixed(2)}</p>

      <button onclick="validarPagoTarjeta('${deudaId}', ${deuda.monto})">Pagar ahora</button>
      <button onclick="cerrarModal()">Cerrar</button>
    </div>
    <div id="modalBackdrop" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;" onclick="cerrarModal()"></div>
  `;

  document.body.insertAdjacentHTML('beforeend', html);
}

function cerrarModal() {
  const modal = document.getElementById("modalTarjeta");
  const backdrop = document.getElementById("modalBackdrop");
  if (modal) {
    modal.remove();
  }
  if (backdrop) {
    backdrop.remove();
  }
}

function validarPagoTarjeta(deudaId, monto) {
  const tarjetaNumero = document.getElementById("numeroTarjeta").value.trim();
  const fechaVencimiento = document.getElementById("fechaVencimiento").value.trim();
  const codigoSeguridad = document.getElementById("codigoSeguridad").value.trim();
  const mensajeDiv = document.getElementById("mensajePago");

  // Validaci√≥n campos generales
  if (!deudaId) {
    alert("Selecciona una deuda para procesar el pago.");
    return;
  }

  // Validar n√∫mero de tarjeta (16 d√≠gitos num√©ricos)
  if (!/^\d{16}$/.test(tarjetaNumero)) {
    alert("N√∫mero de tarjeta inv√°lido. Debe contener exactamente 16 d√≠gitos.");
    return;
  }

  // Validar c√≥digo de seguridad (3 d√≠gitos)
  if (!/^\d{3}$/.test(codigoSeguridad)) {
    alert("C√≥digo de seguridad inv√°lido. Debe contener exactamente 3 d√≠gitos.");
    return;
  }

  // Validar fecha de vencimiento (MM/AA o MM/YYYY)
  const matchFecha = fechaVencimiento.match(/^(\d{2})\/(\d{2,4})$/);
  if (!matchFecha) {
    alert("Formato de fecha inv√°lido. Usa MM/AA o MM/AAAA.");
    return;
  }

  let [_, mes, anio] = matchFecha;
  mes = parseInt(mes);
  anio = parseInt(anio.length === 2 ? "20" + anio : anio);

  const fechaActual = new Date();
  const fechaMax = new Date(2027, 11); // Hasta diciembre 2027

  const fechaTarjeta = new Date(anio, mes - 1);

  if (mes < 1 || mes > 12 || fechaTarjeta < fechaActual || fechaTarjeta > fechaMax) {
    alert("Fecha de vencimiento inv√°lida o fuera del rango permitido.");
    return;
  }

  // Obtener deuda y procesar
  const deuda = deudasUsuario.find(d => d.id === deudaId);
  if (!deuda) {
    alert("Deuda no encontrada.");
    return;
  }

  // Procesar pago
  if (monto > deuda.monto) {
    alert(`El monto a pagar no puede ser mayor al total de la deuda ($${deuda.monto.toFixed(2)}).`);
    return;
  }

  deuda.monto -= monto;

  let msg = `Pago con tarjeta realizado por $${monto.toFixed(2)} para la deuda "${deuda.descripcion}". `;

  if (deuda.monto <= 0.01) {
    deudasUsuario = deudasUsuario.filter(d => d.id !== deudaId);
    msg += "Deuda saldada completamente.";
    
    // Actualizar el registro de deudas por c√©dula
    const cedula = Object.keys(registroDeudasPorCedula).find(c => registroDeudasPorCedula[c] === deudasUsuario);
    if (cedula) {
      registroDeudasPorCedula[cedula] = deudasUsuario;
    }
  } else {
    msg += `Saldo restante: $${deuda.monto.toFixed(2)}.`;
  }

  mensajeDiv.innerHTML = `<p style="color:green;">${msg}</p>`;

  if (deudasUsuario.length === 0) {
    document.getElementById("contenidoDeudas").innerHTML = `<p>No quedan deudas pendientes.</p>`;
    document.getElementById("btnPagarDeudas").disabled = true;
    document.getElementById("btnFacilidadesPago").disabled = true;
  } else {
    mostrarPagoDeudas();
  }

  cerrarModal(); // Cerrar el modal despu√©s de procesar el pago
}

function procesarPagoTarjeta() {
  const numero = document.getElementById("numeroTarjeta").value.trim();
  const vencimiento = document.getElementById("vencimientoTarjeta").value.trim();
  const cvv = document.getElementById("codigoSeguridad").value.trim();
  const id = document.getElementById("selectDeudaPago").value;
  const montoInput = document.getElementById("montoPago").value;
  const monto = parseFloat(montoInput);
  const mensajeDiv = document.getElementById("mensajePago");

  const regexNumero = /^\d{16}$/;
  const regexCVV = /^\d{3}$/;
  const regexVencimiento = /^(0[1-9]|1[0-2])\/(2[5-7])$/; // MM/25 a MM/27

  if (!regexNumero.test(numero)) {
    alert("N√∫mero de tarjeta inv√°lido. Debe tener exactamente 16 d√≠gitos num√©ricos.");
    return;
  }

  if (!regexVencimiento.test(vencimiento)) {
    alert("Fecha de vencimiento inv√°lida o caducada. Use formato MM/AA, m√°ximo 12/27.");
    return;
  }

  if (!regexCVV.test(cvv)) {
    alert("C√≥digo de seguridad inv√°lido. Debe tener exactamente 3 d√≠gitos.");
    return;
  }

  if (!id || isNaN(monto) || monto <= 0) {
    alert("Completa correctamente los campos para procesar el pago.");
    return;
  }

  const deuda = deudasUsuario.find(d => d.id === id);
  if (!deuda) {
    alert("Deuda no encontrada.");
    return;
  }

  if (monto > deuda.monto) {
    alert(`El monto a pagar no puede ser mayor al total de la deuda ($${deuda.monto.toFixed(2)}).`);
    return;
  }

  deuda.monto -= monto;

  let msg = `‚úÖ Pago con tarjeta realizado por $${monto.toFixed(2)} para la deuda "${deuda.descripcion}". `;

  if (deuda.monto <= 0.01) {
    deudasUsuario = deudasUsuario.filter(d => d.id !== id);
    msg += "Deuda saldada completamente.";
  } else {
    msg += `Saldo restante: $${deuda.monto.toFixed(2)}.`;
  }

  mensajeDiv.innerHTML = `<p style="color:green;">${msg}</p>`;

  if (deudasUsuario.length === 0) {
    document.getElementById("contenidoDeudas").innerHTML = `<p>No quedan deudas pendientes.</p>`;
    document.getElementById("btnPagarDeudas").disabled = true;
    document.getElementById("btnFacilidadesPago").disabled = true;
  } else {
    mostrarPagoDeudas();
  }
}


function generarBoletinPagoEfectivo() {
  const id = document.getElementById("selectDeudaPago").value;

  if (!id) {
    alert("Selecciona una deuda para procesar el pago.");
    return;
  }

  const deuda = deudasUsuario.find(d => d.id === id);
  if (!deuda) {
    alert("Deuda no encontrada.");
    return;
  }

  // Usar el monto total de la deuda seleccionada
  const monto = deuda.monto;

  const nombresEjemplo = ["Carlos P√©rez", "Ana G√≥mez", "Luis Rodr√≠guez", "Mar√≠a S√°nchez", "Jorge Torres"];
  const nombreAleatorio = nombresEjemplo[Math.floor(Math.random() * nombresEjemplo.length)];
  const cedula = Object.keys(registroDeudasPorCedula).find(c => registroDeudasPorCedula[c] === deudasUsuario);

  let contenido = `BOLET√çN DE PAGO EN EFECTIVO\n`;
  contenido += `Nombre: ${nombreAleatorio}\n`;
  contenido += `C√©dula: ${cedula || 'Desconocido'}\n`;
  contenido += `Deuda: ${deuda.descripcion}\n`;
  contenido += `Monto a pagar: $${monto.toFixed(2)}\n`;
  contenido += `Fecha de emisi√≥n: ${new Date().toLocaleString()}\n`;
  contenido += `\nPor favor acerquese a una entidad bancaria autorizada para realizar su pago.\n`;

  const blob = new Blob([contenido], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `boletin_pago_efectivo_${cedula || 'usuario'}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


// --- FUNCIONES PARA FACILIDADES DE PAGO ---

// Muestra solo input para c√©dula al principio
function mostrarFacilidadesPago() {
  document.getElementById("contenidoDeudas").innerHTML = `
    <h3>Solicitar Facilidades de Pago</h3>
    <label>C√©dula/RUC:</label>
    <input type="text" id="cedulaFacilidad" placeholder="Ej: 0102030405" oninput="cargarDeudasFacilidad()">
    <div id="deudasFacilidad" style="margin-top:10px;"></div>
    <div id="facilidadOpciones" style="margin-top:10px;"></div>
    <div id="mensajeFacilidad" style="margin-top:10px;"></div>
  `;
}

function cargarDeudasFacilidad() {
  const cedula = document.getElementById("cedulaFacilidad").value.trim();
  const divDeudas = document.getElementById("deudasFacilidad");
  const divOpciones = document.getElementById("facilidadOpciones");
  const mensajeDiv = document.getElementById("mensajeFacilidad");

  mensajeDiv.innerHTML = "";
  divOpciones.innerHTML = "";
  divDeudas.innerHTML = "";

  if (!validarCedula(cedula)) {
    return;
  }

  if (!registroDeudasPorCedula.hasOwnProperty(cedula)) {
    divDeudas.innerHTML = `<p style="color:green;">No se encontraron deudas para la c√©dula ${cedula}.</p>`;
    return;
  }

  deudasUsuario = registroDeudasPorCedula[cedula];
  if (deudasUsuario.length === 0) {
    divDeudas.innerHTML = `<p style="color:green;">No se encontraron deudas para la c√©dula ${cedula}.</p>`;
    return;
  }

  // Mostrar las deudas sin checkboxes
  let html = `<p><strong>Deudas encontradas:</strong></p><ul>`;
  deudasUsuario.forEach(d => {
    html += `<li>${d.descripcion} - $${d.monto.toFixed(2)}</li>`;
  });
  html += "</ul>";
  divDeudas.innerHTML = html;

  // Mostrar opciones de cuotas y bot√≥n solicitar
  const totalDeuda = deudasUsuario.reduce((sum, d) => sum + d.monto, 0);
  divOpciones.innerHTML = `
    <p><strong>Total de deudas:</strong> $${totalDeuda.toFixed(2)}</p>
    <label>Selecciona n√∫mero de cuotas (entre 2 y 30):</label>
    <select id="cuotasSelect" onchange="actualizarDetalleCuota()">
      ${Array.from({ length: 29 }, (_, i) => i + 2).map(q => `<option value="${q}">${q} cuotas</option>`).join('')}
    </select>
    <p id="detalleCuota" style="margin-top:8px;"></p>
    <button onclick="validarFacilidadesPago()">Solicitar</button>
  `;
  actualizarDetalleCuota();
}


// Actualiza el detalle del valor de la cuota seg√∫n selecci√≥n y deudas marcadas
function actualizarDetalleCuota() {
  const cuotas = parseInt(document.getElementById("cuotasSelect").value);
  
  // Calcular el total de las deudas mostradas
  const totalDeuda = deudasUsuario.reduce((sum, d) => sum + d.monto, 0);

  if (totalDeuda === 0) {
    document.getElementById("detalleCuota").innerHTML = `<em>No hay deudas para calcular.</em>`;
  } else {
    const valorCuota = totalDeuda / cuotas;
    document.getElementById("detalleCuota").innerHTML = `Cada cuota ser√° de: <strong>$${valorCuota.toFixed(2)}</strong>`;
  }
}


// Validaci√≥n y env√≠o de solicitud de facilidad de pago + generaci√≥n archivo .txt
function validarFacilidadesPago() {
  const cedula = document.getElementById("cedulaFacilidad").value.trim();
  const cuotas = parseInt(document.getElementById("cuotasSelect").value);
  const mensajeDiv = document.getElementById("mensajeFacilidad");

  // Validar c√©dula
  if (!validarCedula(cedula)) {
    alert("C√©dula inv√°lida. Ingrese una c√©dula ecuatoriana v√°lida.");
    return;
  }

  // Validar n√∫mero de cuotas
  if (isNaN(cuotas) || cuotas < 2 || cuotas > 30) {
    alert("Selecciona un n√∫mero de cuotas entre 2 y 30.");
    return;
  }

  // Calcular total de la selecci√≥n
  const totalSeleccion = deudasUsuario.reduce((sum, d) => sum + d.monto, 0);
  const valorCuota = totalSeleccion / cuotas;

  // Mostrar mensaje de confirmaci√≥n
  mensajeDiv.innerHTML = `
    <p style="color:green;">
      Solicitud enviada correctamente.<br>
      Total deuda seleccionada: $${totalSeleccion.toFixed(2)}<br>
      N√∫mero de cuotas: ${cuotas}<br>
      Valor por cuota: $${valorCuota.toFixed(2)}
    </p>
  `;

  // Generar archivo .txt con los datos
  generarArchivoTxtFacilidad(cedula, deudasUsuario, cuotas, valorCuota);
}

// Funci√≥n para generar archivo .txt y descargarlo autom√°ticamente
function generarArchivoTxtFacilidad(cedula, deudasSeleccionadas, cuotas, valorCuota) {
  // Generar un nombre aleatorio para el ejemplo
  const nombresEjemplo = ["Carlos P√©rez", "Ana G√≥mez", "Luis Rodr√≠guez", "Mar√≠a S√°nchez", "Jorge Torres"];
  const nombreAleatorio = nombresEjemplo[Math.floor(Math.random() * nombresEjemplo.length)];

  // Crear contenido del archivo
  let contenido = `Solicitud de Facilidades de Pago\n`;
  contenido += `Nombre: ${nombreAleatorio}\n`;
  contenido += `C√©dula: ${cedula}\n\n`;
  contenido += `Deudas seleccionadas:\n`;
  
  // Listar deudas seleccionadas
  deudasSeleccionadas.forEach(d => {
    contenido += `- ${d.descripcion}: $${d.monto.toFixed(2)}\n`;
  });
  
  contenido += `\nN√∫mero de cuotas: ${cuotas}\n`;
  contenido += `Valor por cuota: $${valorCuota.toFixed(2)}\n`;
  contenido += `Fecha de solicitud: ${new Date().toLocaleString()}\n`;
  contenido += `\nGracias por utilizar nuestro servicio.`;

  // Crear Blob y forzar descarga
  const blob = new Blob([contenido], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `solicitud_facilidad_${cedula}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

        //===========================================================================================================================================0
        //===========================================================================================================================================0
    </script>

    <footer  style="text-align:justify; background: #004b8d; color: white; position: fixed; bottom: 0; width: 100%; height: auto; margin: auto;">
      ¬© 2025 Sistema Web SRI
    </footer>
  </body>
</html>
