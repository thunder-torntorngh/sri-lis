<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistema SRI Web - Estilo Moderno</title>

    <style>
      * {
        box-sizing: border-box;
        font-family: 'Arial', sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        color: #333;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .error-message {
        display: none; 
        color: red;
      }


      .consulta-container {
  background: #ffffff;
  border: 1px solid #ccc;
  padding: 20px;
  border-radius: 6px;
  max-width: 600px;
  margin: 20px auto;
  font-family: Arial, sans-serif;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.consulta-container h3 {
  color: #004884;
  text-align: center;
  margin-bottom: 18px;
}

.input {
  width: 100%;
  padding: 8px;
  margin: 8px 0 16px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
}

.btn-consultar {
  width: 100%;
  background: #004884;
  color: #fff;
  border: none;
  padding: 10px;
  font-size: 15px;
  border-radius: 4px;
  cursor: pointer;
}

.btn-consultar:hover {
  background: #003366;
}

.resultado-consulta {
  margin-top: 20px;
}

.resultado-header p {
  margin: 4px 0;
  font-size: 14px;
}

.tabla-rubros {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

.tabla-rubros th,
.tabla-rubros td {
  border: 1px solid #ddd;
  padding: 8px;
  font-size: 14px;
}

.tabla-rubros th {
  background: #f5f5f5;
  text-align: center;
}

.tabla-rubros tfoot td {
  background: #f9f9f9;
  font-size: 15px;
}

.resultado-acciones {
  margin-top: 15px;
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

.resultado-acciones button {
  background: #0066cc;
  color: #fff;
  border: none;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.resultado-acciones button:hover {
  background: #0055aa;
}



      /* --- Login --- */
      #login-container {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: linear-gradient(135deg, #004b8d, #0077cc);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .login-box {
        width: 350px;
        padding: 30px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: all 0.3s ease;
      }

      .login-box.hidden {
        transform: translateY(-20px);
        opacity: 0;
      }

      .login-box h2 {
        color: #004b8d;
        margin-bottom: 20px;
      }

      /* --- Sidebar --- */
      .sidebar {
        position: fixed;
        top: 0; left: 0;
        height: 100vh;
        width: 240px;
        background-color: #002b5c;
        color: white;
        box-shadow: 2px 0 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        overflow-y: auto;
      }

      .sidebar .logo {
        text-align: center;
        font-size: 26px;
        font-weight: bold;
        padding: 20px;
        background: #004b8d;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .nav-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .nav-list li {
        padding: 15px 20px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .nav-list li:hover {
        background-color: #0069d9;
      }

      /* --- Topbar --- */
      .topbar {
        position: fixed;
        top: 0; left: 240px;
        height: 60px;
        width: calc(100% - 240px);
        background-color: #004b8d;
        color: white;
        display: flex;
        align-items: center;
        padding: 0 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 999;
      }

      .topbar h1 {
        margin: 0;
        font-size: 20px;
        font-weight: bold;
      }

      /* --- Contenedor principal --- */
      .main-container {
        margin-left: 240px;
        margin-top: 60px;
        padding: 20px;
        flex: 1;
        padding-bottom: 60px; /* Espacio para footer */
      }

      /* --- Footer --- */
      footer {
        text-align: center;
        padding: 12px;
        background: #004b8d;
        color: white;
        height: 50px;
        line-height: 50px;
        font-size: 16px;
        position: relative;
        width: 100%;
      }

      /* --- Responsive --- */
      @media (max-width: 900px) {
        .sidebar {
          width: 200px;
        }

        .topbar {
          left: 200px;
          width: calc(100% - 200px);
        }

        .main-container {
          margin-left: 200px;
        }
      }

      @media (max-width: 600px) {
        .sidebar {
          width: 100%;
          height: auto;
          position: relative;
        }

        .topbar {
          left: 0;
          width: 100%;
          position: relative;
        }

        .main-container {
          margin-left: 0;
          margin-top: 0;
          padding-top: 20px;
        }
      }

      /* --- Botones, Formularios y Estilos Secundarios (resumen) --- */
      button {
        padding: 10px 16px;
        background-color: #004b8d;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #0069d9;
      }

      h2, h3, h4 {
        color: #004b8d;
      }

      .input-group input,
      input, select {
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        width: 100%;
      }

      .modulo {
        display: none;
      }

      .modulo.active {
        display: block;
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      }

      /* --- Formulario RUC --- */
    #formularioRUC {
        max-width: 500px;
        margin: 30px auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    #formularioRUC h3 {
        text-align: center;
        color: #004b8d;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: bold;
    }

    #formularioRUC form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    #formularioRUC input,
    #formularioRUC select {
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    #formularioRUC input:focus,
    #formularioRUC select:focus {
        border-color: #3498db;
        outline: none;
    }

    #formularioRUC button {
        padding: 12px;
        background-color: #004b8d;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #formularioRUC button:hover {
        background-color: #0069d9;
    }

    /* --- Facturación: centrado y estilos --- */
    #facturacion {
        display: flex; /* Cambiado a flex */
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    #facturacion .subopciones {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-top: 20px;
        width: 100%;
    }

    #facturacion .subopciones button {
        width: 280px;
        background-color: #004b8d;
        color: #fff;
        padding: 12px 20px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-align: center;
        transition: background-color 0.3s ease;
    }

    #facturacion .subopciones button:hover {
        background-color: #0069d9;
    }

    #facturacion h2 {
        color: #004b8d;
        margin-bottom: 10px;
    }

    /* --- Formularios de facturación --- */
    #facturacionFisica,
    #facturacionElectronica {
        max-width: 600px;
        margin: 30px auto;
        padding: 25px;
        background-color: #ffffff;
        border-radius: 10px;
        border: 1px solid #ddd;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
    }

    #facturacionElectronica {
        background-color: #eef6ff;
    }

    #facturacionFisica h2,
    #facturacionElectronica h2,
    #facturacionFisica form,
    #facturacionElectronica form {
        text-align: center;
    }

    #facturacionFisica form,
    #facturacionElectronica form {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }

    #facturacionFisica input,
    #facturacionElectronica input {
        width: 100%;
        max-width: 480px;
        padding: 10px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 6px;
    }

    #facturacionFisica button,
    #facturacionElectronica button {
        background-color: #28a745;
        border: none;
        padding: 12px;
        border-radius: 6px;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #facturacionFisica button:hover,
    #facturacionElectronica button:hover {
        background-color: #218838;
    }

      .consulta-container {
    background-color: #f0f4f8;
    padding: 20px;
    border-radius: 8px;
    max-width: 600px;
    margin: 20px auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    font-family: Arial, sans-serif;
  }

  .consulta-container h3 {
    color: #003366;
    margin-bottom: 15px;
    text-align: center;
  }

  .input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .btn-consultar {
    background-color: #0066cc;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    font-weight: bold;
  }

  .btn-consultar:hover {
    background-color: #004a99;
  }

  .resultado-consulta {
    margin-top: 20px;
  }

      
    </style>


  </head>
  <body>
    <!-- Login Interface -->
    <div id="login-container">
        <div class="login-box" id="login-box">
            <h2>Iniciar Sesión</h2>
            
            <div class="input-group">
                <input type="text" id="inputUsername" placeholder="Ingresa tu usuario">
                <input type="password" id="inputPassword" placeholder="Ingresa tu contraseña">
            </div>
            
            <button class="login-btn" onclick="attemptLogin()">Ingresar</button>
            <div id="error-message" class="error-message">Usuario o contraseña incorrectos</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div id="main-content" style="display: none;">

      <!-- Menú lateral -->
      <aside class="sidebar" id="sidebar">
        <div class="logo">SRI</div>
        <ul class="nav-list">
          <li onclick="mostrar('dimm')"><span>🪪</span> DIMM</li>
          <li onclick="mostrar('facturacion')"><span>📄</span> Facturación</li>
          <li onclick="mostrar('anexos')"><span>📂</span> Anexos</li>
          <li onclick="mostrar('deudas')"><span>📉</span> Deudas</li>
          <li onclick="mostrar('vehiculos')"><span>🚗</span> Vehículos</li>
          <li onclick="mostrar('grafica')"><span>📊</span> Gráfica</li>
        </ul>
      </aside>

      <!-- Encabezado superior -->
      <header class="topbar">
        <h1 class="topbar-title">Sistema Web - SRI</h1>
        
        <div id="usuarioInfo" style="display: none;">
          <span id="nombreUsuario">👤</span>
          <button onclick="cerrarSesion()" style="background: none; border: none; color: #004b8d; cursor: pointer; font-size: 18px;">🚪</button>
        </div>
      </header>


      <!-- Contenido principal -->
      <main class="main-container">
        <section id="inicio" class="modulo">
          <h2>Bienvenido al Sistema Web del SRI</h2>
          <p>Selecciona una opción del menú para continuar.</p>
        </section>

        <!-- Módulo DIMM -->
        <section id="dimm" class="modulo">
          <h2>Gestión de RUC</h2>
          <div class="subopciones">
            <button onclick="nuevoRUC()">Nuevo</button>
            <button onclick="editarRUC()">Editar</button>
            <button onclick="eliminarRUC()">Eliminar</button>
          </div>
          <div id="contenidoDIMM"></div>
        </section>


        <!-- Módulo de Vehículos -->
        <section id="vehiculos" class="modulo" style="display: none; text-align: center;">
          <h2>Consultar sus reportes</h2>
          <div class="subopciones">
            <button onclick="mostrarConsultaVehiculo('placa')">Consultar reportes</button>
            <button onclick="mostrarPagosRealizados()">Reportes de pago</button>
          </div>

          <div id="contenidoVehiculo"></div>
          <div id="seccionPagosRealizados" style="margin-top: 40px;"></div>
          <div id="modalDetallesPago" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:2px solid #444; max-width:90%; max-height:80%; overflow-y:auto; z-index:1000;"></div>
          <div id="modalPagoTarjeta" style="display:none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: white; border: 2px solid #444; padding: 20px; max-width: 400px; z-index: 10000;"></div>
        </section>






        <!-- Módulo Deudas -->
        <section id="deudas" class="modulo" style="display:center;">
          <h2>Módulo Deudas</h2>
          <div class="subopciones">
            <button onclick="mostrarConsultaDeudas()">Consultar Deudas</button>
            <button id="btnPagarDeudas" onclick="mostrarPagoDeudas()" disabled>Pagar Deudas</button>
            <button id="btnFacilidadesPago" onclick="mostrarFacilidadesPago()" disabled>Solicitar Facilidades de Pago</button>
          </div>

          <div id="contenidoDeudas"></div>
        </section>

        <!-- Módulo Anexos -->
        <section id="anexos" class="modulo hidden">
          <h2>Módulo Anexos</h2>
          <div class="subopciones">
            <button onclick="mostrarEnvioConsultaAnexos()">Envío y Consulta de Anexos</button>
            <button onclick="mostrarGastosPersonales()">Anexo de Gastos Personales en Línea</button>
          </div>

          <div id="contenidoAnexos"></div>
        </section>


        
  <!-- Módulo Gráfica -->
  <section id="grafica" class="modulo">
    <h2>Gráfica General</h2>
    <div id="graficas" style="text-align: center;">
      <button onclick="mostrarGrafica()" style="margin-bottom: 15px; padding: 10px 20px; background-color: #0c3a70; color: white; border: none; border-radius: 5px; cursor: pointer;">
        📊 Generar gráfica
      </button>
      <canvas id="graficaSistema" max-width="600" margin="auto" ></canvas>
    </div>
  </section>

    
  <!-- Módulo Facturación -->
  <section id="facturacion" class="modulo" style="display: none;"> <!-- Asegúrate de que esté oculto por defecto -->
    <h2>Autorización de Facturación</h2>
    <div class="subopciones">
      <button onclick="mostrarFacturacionFisica()">📄 Facturación Física</button>
      <button onclick="mostrarFacturacionElectronica()">💻 Facturación Electrónica</button>
    </div>


    <!-- Contenedor para Facturación Física -->
  <div id="facturacionFisica" style="display:none; padding: 20px; background-color: #fff; border-radius: 8px; margin-top: 10px;">
    <h2>Facturación Física - Simulador SRI</h2>
    <form id="formFacturaFisica">
      <h4>Datos del Emisor</h4>
      <input type="text" placeholder="Razón Social" id="emisor" required><br>
      <input type="text" placeholder="RUC" id="rucEmisor" required><br>
      <input type="text" placeholder="Dirección" id="direccionEmisor" required><br>

      <h4>Datos del Cliente</h4>
      <input type="text" placeholder="Nombre del Cliente" id="cliente" required><br>
      <input type="text" placeholder="Cédula/RUC Cliente" id="rucCliente" required><br>

      <h4>Detalles de la Factura</h4>
      <input type="text" placeholder="Descripción del Producto o Servicio" id="detalle" required><br>
      <input type="number" placeholder="Cantidad" id="cantidad" required><br>
      <input type="number" placeholder="Precio Unitario" id="precio" required><br>

      <button type="button" onclick="generarFacturaFisica()">📝 Generar Factura Física</button>
    </form>
  </div>

  <!-- Contenedor para Facturación Electrónica -->
  <div id="facturacionElectronica" style="display:none; padding: 20px; background-color: #eef; border-radius: 8px; margin-top: 10px;">
    <h2>Facturación Electrónica - Simulador SRI</h2>
    <form id="formFacturaElectronica">
      <h4>Datos del Emisor</h4>
      <input type="text" placeholder="Razón Social" id="emisorE" required><br>
      <input type="text" placeholder="RUC" id="rucEmisorE" required><br>
      <input type="text" placeholder="Dirección" id="direccionEmisorE" required><br>

      <h4>Datos del Cliente</h4>
      <input type="text" placeholder="Nombre del Cliente" id="clienteE" required><br>
      <input type="text" placeholder="Cédula/RUC Cliente" id="rucClienteE" required><br>

      <h4>Detalle de la Factura</h4>
      <input type="text" placeholder="Producto o Servicio" id="detalleE" required><br>
      <input type="number" placeholder="Cantidad" id="cantidadE" required><br>
      <input type="number" placeholder="Precio Unitario" id="precioE" required><br>

      <button type="button" onclick="generarFacturaElectronica()">📤 Emitir Factura Electrónica</button>
    </form>
  </div>


  </section>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
          //VARIABLES 
          let listaRUCs = []; 
          let registrosDIMM = [];
          let anexosGuardados = [];


          



          //INICIO DE SECCION

          function attemptLogin() {
            const username = document.getElementById('inputUsername').value;
            const password = document.getElementById('inputPassword').value;
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.style.display = 'none';
            
            if(username === 'Lis' && password === '12345') {
                console.log("Inicio de sesión correcto");
                
                // Ocultar login box con animación
                document.getElementById('login-box').classList.add('hidden');
                
                // Mostrar contenido principal después de la animación
                setTimeout(() => {
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('main-content').style.display = 'block';
                    document.getElementById('username-display').textContent = username;
                }, 300);
            } else {
                console.warn("Fallo en inicio de sesión");
                errorMessage.style.display = 'block';
                document.getElementById('inputPassword').value = '';
            }
          }




          // SECCIÓN RUC - Generación del formulario
      function nuevoRUC() {
        const contenido = document.getElementById("contenidoDIMM");

        contenido.innerHTML = `
          <div id="formularioRUC" class="form-card">
            <h3 class="form-title">Registrar RUC</h3>
            <form onsubmit="return validarFormularioRUC()" class="form-body">
              <div class="form-group">
                <input type="text" id="ruc" placeholder="RUC (13 dígitos)" required />
              </div>
              <div class="form-group">
                <input type="text" id="razonSocial" placeholder="Razón Social" required />
              </div>
              <div class="form-group">
                <input type="text" id="direccion" placeholder="Dirección Matriz" required />
              </div>
              <div class="form-group">
                <input type="text" id="celular" placeholder="Número Celular (10 dígitos)" required />
              </div>
              <div class="form-group">
                <input type="email" id="correo" placeholder="Correo Electrónico" required />
              </div>
              <div class="form-group">
                <select id="tipoIdentificacion" required onchange="actualizarPlaceholder()">
                  <option value="">Seleccione tipo de identificación</option>
                  <option value="cedula">Cédula</option>
                  <option value="pasaporte">Pasaporte</option>
                </select>
              </div>
              <div class="form-group">
                <input type="text" id="identificacion" placeholder="Número de Cédula o Pasaporte" required />
              </div>
              <div class="form-group">
                <button type="submit">Registrar</button>
              </div>
            </form>
          </div>
        `;
      }


      // Validación del formulario RUC
      function validarFormularioRUC() {
        const ruc = document.getElementById('ruc').value.trim();
        const razonSocial = document.getElementById('razonSocial').value.trim();
        const direccion = document.getElementById('direccion').value.trim();
        const celular = document.getElementById('celular').value.trim();
        const correo = document.getElementById('correo').value.trim();
        const tipoID = document.getElementById('tipoIdentificacion').value;
        const identificacion = document.getElementById('identificacion').value.trim();

        // Validaciones...
        if (!/^\d{13}$/.test(ruc) || !ruc.endsWith("001")) {
          alert("El RUC debe tener 13 dígitos numéricos y terminar en '001'.");
          return false;
        }
        if (razonSocial.length < 3) {
          alert("La razón social debe tener al menos 3 caracteres.");
          return false;
        }
        if (direccion.length < 5) {
          alert("La dirección matriz debe tener al menos 5 caracteres.");
          return false;
        }
        if (!/^09\d{8}$/.test(celular)) {
          alert("El número celular debe tener 10 dígitos y comenzar con '09'.");
          return false;
        }
        const correoRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.([a-z]{2,}|com|net|org|edu|ec|gob\.ec)$/i;
        if (!correoRegex.test(correo)) {
          alert("El correo debe tener un formato válido y usar un dominio permitido.");
          return false;
        }
        if (tipoID === "cedula") {
          if (!/^\d{10}$/.test(identificacion)) {
            alert("La cédula debe tener exactamente 10 dígitos.");
            return false;
          }
        } else if (tipoID === "pasaporte") {
          if (!/^[a-zA-Z0-9]{6,12}$/.test(identificacion)) {
            alert("El pasaporte debe tener entre 6 y 12 caracteres alfanuméricos.");
            return false;
          }
        } else {
          alert("Debe seleccionar un tipo de identificación.");
          return false;
        }

        // Guardar en array
        const nuevoRUC = {
          ruc,
          razonSocial,
          direccion,
          celular,
          correo,
          tipoID,
          identificacion
        };

        listaRUCs.push(nuevoRUC);

        alert("Formulario enviado correctamente.");
        return false; // Previene que el form recargue
      }


      // Actualiza el texto del placeholder según el tipo de identificación
      function actualizarPlaceholder() {
        const tipo = document.getElementById("tipoIdentificacion").value;
        const input = document.getElementById("identificacion");

        if (tipo === "cedula") {
          input.placeholder = "Número de Cédula (10 dígitos)";
        } else if (tipo === "pasaporte") {
          input.placeholder = "Número de Pasaporte (6 a 12 caracteres)";
        } else {
          input.placeholder = "Número de Cédula o Pasaporte";
        }
      }

      //EDICION DE RUC
      function editarRUC() {
        const contenido = document.getElementById("contenidoDIMM");

        if (listaRUCs.length === 0) {
          contenido.innerHTML = `<p>No hay RUCs registrados para editar.</p>`;
          return;
        }

        let html = `<h3>Editar RUC</h3>`;
        html += `<ul style="list-style: none; padding: 0;">`;

        listaRUCs.forEach((rucObj, index) => {
          html += `
            <li style="margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 6px;">
              <strong>${rucObj.razonSocial}</strong> (${rucObj.ruc})
              <br/>
              <button onclick="cargarEdicionRUC(${index})">Editar</button>
            </li>
          `;
        });

        html += `</ul>`;
        contenido.innerHTML = html;
      }

      function cargarEdicionRUC(index) {
        const r = listaRUCs[index];
        const contenido = document.getElementById("contenidoDIMM");

        contenido.innerHTML = `
          <h3>Editar RUC</h3>
          <form onsubmit="return guardarCambiosRUC(${index})">
            <input type="text" id="rucEdit" value="${r.ruc}" required /><br/>
            <input type="text" id="razonSocialEdit" value="${r.razonSocial}" required /><br/>
            <input type="text" id="direccionEdit" value="${r.direccion}" required /><br/>
            <input type="text" id="celularEdit" value="${r.celular}" required /><br/>
            <input type="email" id="correoEdit" value="${r.correo}" required /><br/>
            <input type="text" id="identificacionEdit" value="${r.identificacion}" required /><br/>
            <button type="submit">Guardar Cambios</button>
          </form>
        `;
      }

      //GUARDADO DE RUC EDITADO
      function guardarCambiosRUC(index) {
        listaRUCs[index].ruc = document.getElementById("rucEdit").value.trim();
        listaRUCs[index].razonSocial = document.getElementById("razonSocialEdit").value.trim();
        listaRUCs[index].direccion = document.getElementById("direccionEdit").value.trim();
        listaRUCs[index].celular = document.getElementById("celularEdit").value.trim();
        listaRUCs[index].correo = document.getElementById("correoEdit").value.trim();
        listaRUCs[index].identificacion = document.getElementById("identificacionEdit").value.trim();

        alert("Cambios guardados correctamente.");
        mostrar("dimm"); // Regresa a módulo
        return false;
      }

      //ELIMINACION DE RUC
      function eliminarRUC() {
        const contenido = document.getElementById("contenidoDIMM");

        if (listaRUCs.length === 0) {
          contenido.innerHTML = `<p>No hay RUCs registrados para eliminar.</p>`;
          return;
        }

        let html = `<h3>Eliminar RUC</h3>`;
        html += `<ul style="list-style: none; padding: 0;">`;

        listaRUCs.forEach((rucObj, index) => {
          html += `
            <li style="margin-bottom: 10px; background: #fce9e9; padding: 10px; border-radius: 6px;">
              <strong>${rucObj.razonSocial}</strong> (${rucObj.ruc})
              <br/>
              <button onclick="confirmarEliminarRUC(${index})" style="background-color: red;">Eliminar</button>
            </li>
          `;
        });

        html += `</ul>`;
        contenido.innerHTML = html;
      }

      function confirmarEliminarRUC(index) {
        if (confirm("¿Está seguro de eliminar este RUC?")) {
          listaRUCs.splice(index, 1);
          alert("RUC eliminado correctamente.");
          eliminarRUC(); // Actualizar vista
        }
      }


      //MOSTRAR MODULOS
        function mostrar(modulo) {
          const modulos = document.querySelectorAll('.modulo');
          modulos.forEach(m => {
            m.classList.add('hidden');
            m.classList.remove('active');
            m.style.display = 'none'; // Asegúrate de ocultar el módulo
          });
          const target = document.getElementById(modulo);
          if (target) {
            target.classList.remove('hidden');
            target.classList.add('active');
            target.style.display = 'block'; // Mostrar el módulo seleccionado
          }
        }

      let idEditar = null;

      // Mostrar módulo para crear/editar anexos, importar, descargar, enviar y eliminar
      function mostrarEnvioConsultaAnexos() {
        mostrar('anexos');

        const contenido = `
          <div style="margin-top: 15px;">
            <button onclick="mostrarFormNuevoAnexo()">Nuevo Anexo</button>
            <button onclick="mostrarListaAnexos()">Lista de Anexos</button>
          </div>

          <div id="formAnexo" style="display:none; margin-top: 15px;"></div>
          <div id="listaAnexos" style="margin-top: 15px;"></div>
        `;

        document.getElementById('contenidoAnexos').innerHTML = contenido;

        mostrarListaAnexos();
      }

      function mostrarFormNuevoAnexo() {
        idEditar = null;
        const formHtml = `
          <h3 id="tituloForm">Crear Nuevo Anexo</h3>

          <label>Importar archivo (.txt, .xls, .xlsx):</label><br/>
          <input type="file" id="inputFileAnexo" accept=".txt, .xls, .xlsx" onchange="cargarArchivo(event)"/>

          <label for="nombreAnexo">Nombre del anexo:</label>
          <input type="text" id="nombreAnexo" placeholder="Ejemplo: anexo1.txt" style="width: 100%; padding: 8px; margin-bottom: 10px;"/>

          <label for="contenidoAnexo">Contenido del anexo:</label>
          <textarea id="contenidoAnexo" rows="10" style="width: 100%; padding: 8px;"></textarea>

          <div style="margin-top: 10px;">
            <button onclick="guardarAnexo()">Guardar</button>
            <button onclick="limpiarForm()">Cancelar</button>
          </div>
        `;
        document.getElementById('formAnexo').innerHTML = formHtml;
        document.getElementById('formAnexo').style.display = 'block';
        document.getElementById('listaAnexos').style.display = 'none';
        limpiarForm();
      }

      function mostrarListaAnexos() {
        document.getElementById('formAnexo').style.display = 'none';
        document.getElementById('listaAnexos').style.display = 'block';
        renderizarAnexos();
      }

      function limpiarForm() {
        const fileInput = document.getElementById('inputFileAnexo');
        if (fileInput) fileInput.value = '';
        const nombre = document.getElementById('nombreAnexo');
        if (nombre) nombre.value = '';
        const contenido = document.getElementById('contenidoAnexo');
        if (contenido) contenido.value = '';
      }

      // Cargar archivo .txt y excel para mostrar en el textarea y el nombre
      function cargarArchivo(event) {
        const file = event.target.files[0];
        if (!file) return;

        const nombreInput = document.getElementById('nombreAnexo');
        const contenidoInput = document.getElementById('contenidoAnexo');

        const ext = file.name.split('.').pop().toLowerCase();

        if (ext === "txt") {
          const reader = new FileReader();
          reader.onload = function(e) {
            contenidoInput.value = e.target.result;
            nombreInput.value = file.name;
          };
          reader.readAsText(file);

        } else if (ext === "xls" || ext === "xlsx") {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const data = e.target.result;
              const workbook = XLSX.read(data, { type: "array" });
              const primeraHoja = workbook.Sheets[workbook.SheetNames[0]];
              const csv = XLSX.utils.sheet_to_csv(primeraHoja);
              contenidoInput.value = csv;
              nombreInput.value = file.name;
            } catch (error) {
              alert("Error al leer el archivo Excel: " + error.message);
              nombreInput.value = "";
              contenidoInput.value = "";
            }
          };
          reader.readAsArrayBuffer(file);

        } else {
          alert("Solo se aceptan archivos .txt, .xls o .xlsx");
          event.target.value = "";
        }
      }

      function guardarAnexo() {
        const nombre = document.getElementById('nombreAnexo').value.trim();
        const contenido = document.getElementById('contenidoAnexo').value.trim();

        if (!nombre) {
          alert("Debe ingresar un nombre para el anexo");
          return;
        }
        if (!contenido) {
          alert("El contenido no puede estar vacío");
          return;
        }

        if (idEditar === null) {
          anexosGuardados.push({
            id: Date.now(),
            nombre,
            contenido
          });
          alert("Anexo guardado con éxito");
        } else {
          const index = anexosGuardados.findIndex(a => a.id === idEditar);
          if (index > -1) {
            anexosGuardados[index].nombre = nombre;
            anexosGuardados[index].contenido = contenido;
            alert("Anexo actualizado con éxito");
          }
        }

        limpiarForm();
        mostrarListaAnexos();
      }

      function renderizarAnexos() {
        const lista = document.getElementById("listaAnexos");
        lista.innerHTML = "";

        if (anexosGuardados.length === 0) {
          lista.innerHTML = "<p>No hay anexos guardados.</p>";
          return;
        }

        anexosGuardados.forEach(anexo => {
          const div = document.createElement("div");
          div.style.border = "1px solid #ccc";
          div.style.padding = "10px";
          div.style.marginBottom = "10px";
          div.style.borderRadius = "5px";

          div.innerHTML = `
            <strong>Nombre:</strong> ${anexo.nombre}<br/><br/>
            <pre style="background:#f4f4f4; padding:10px; border-radius:4px; max-height:150px; overflow:auto;">${anexo.contenido}</pre>
            <div style="margin-top: 10px;">
              <button onclick="editarAnexo(${anexo.id})">✏️ Editar</button>
              <button onclick="descargarAnexo(${anexo.id})">📥 Descargar</button>
              <button onclick="simularEnvio(${anexo.id})">📤 Enviar</button>
              <button onclick="eliminarAnexo(${anexo.id})" style="color:red;">🗑️ Eliminar</button>
            </div>
          `;

          lista.appendChild(div);
        });
      }

      function editarAnexo(id) {
        const anexo = anexosGuardados.find(a => a.id === id);
        if (!anexo) return;

        idEditar = id;
        document.getElementById('tituloForm').innerText = "Editar Anexo";
        mostrarFormNuevoAnexo();
        document.getElementById('nombreAnexo').value = anexo.nombre;
        document.getElementById('contenidoAnexo').value = anexo.contenido;
      }

      function descargarAnexo(id) {
        const anexo = anexosGuardados.find(a => a.id === id);
        if (!anexo) return;

        const blob = new Blob([anexo.contenido], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = anexo.nombre;
        link.click();
      }

      function simularEnvio(id) {
        const anexo = anexosGuardados.find(a => a.id === id);
        if (!anexo) return;

        alert(`El anexo "${anexo.nombre}" ha sido enviado con éxito.\nContenido:\n${anexo.contenido}`);
      }

      function eliminarAnexo(id) {
        if (!confirm("¿Está seguro que desea eliminar este anexo?")) return;

        anexosGuardados = anexosGuardados.filter(a => a.id !== id);
        renderizarAnexos();
      }



        function mostrarGastosPersonales() {
        mostrar('anexos');

        const contenido = `
          <h3>Anexo de Gastos Personales</h3>
          <p>Selecciona una opción:</p>
          <button onclick="mostrarBeneficiario()">Beneficiario de pensión alimenticia</button>

          <div id="contenidoBeneficiario" style="margin-top: 20px;"></div>
        `;

        document.getElementById('contenidoAnexos').innerHTML = contenido;
      }

      function mostrarBeneficiario() {
        const contenedor = document.getElementById('contenidoBeneficiario');
        contenedor.innerHTML = `
          <h4>Verificación de Beneficiario</h4>
          <label for="cedulaRuc">Ingrese RUC o Cédula:</label>
          <input type="text" id="cedulaRuc" placeholder="Ej. 0102030405" maxlength="13"/>
          <button onclick="verificarBeneficiario()">Verificar</button>
          <div id="resultadoBeneficiario" style="margin-top: 10px;"></div>
        `;
      }

      function verificarBeneficiario() {
        const input = document.getElementById('cedulaRuc').value.trim();
        const resultado = document.getElementById('resultadoBeneficiario');

        if (!/^\d{10,13}$/.test(input)) {
          resultado.innerHTML = `<p style="color: red;">❌ Ingrese un número válido de RUC o Cédula (10 o 13 dígitos).</p>`;
          return;
        }

        const esBeneficiario = Math.random() < 0.5;

        resultado.innerHTML = esBeneficiario
          ? `<p style="color: green;">✅ El número ingresado SÍ es beneficiario de pensión alimenticia.</p>`
          : `<p style="color: orange;">❌ El número ingresado NO es beneficiario de pensión alimenticia.</p>`;
      }


        //FACTURACIÓN

        

      // Facturación


      function mostrarFacturacionFisica() {
        const contenedor = document.getElementById("facturacionFisica").style.display = "block";
        document.getElementById("facturacionElectronica").style.display = "none";

        contenedor.style.display = "block";
        contenedor.innerHTML = `
          <h2>Facturación Física - Simulador SRI</h2>
          <form id="formFacturaFisica">
            <h4>Datos del Emisor</h4>
            <input type="text" placeholder="Razón Social" id="emisor" required><br>
            <input type="text" placeholder="RUC" id="rucEmisor" required><br>
            <input type="text" placeholder="Dirección" id="direccionEmisor" required><br>

            <h4>Datos del Cliente</h4>
            <input type="text" placeholder="Nombre del Cliente" id="cliente" required><br>
            <input type="text" placeholder="Cédula/RUC Cliente" id="rucCliente" required><br>

            <h4>Detalles de la Factura</h4>
            <input type="text" placeholder="Descripción del Producto o Servicio" id="detalle" required><br>
            <input type="number" placeholder="Cantidad" id="cantidad" required><br>
            <input type="number" placeholder="Precio Unitario" id="precio" required><br>

            <button type="button" onclick="generarFacturaFisica()">📝 Generar Factura</button>
          </form>
        `;
      }


      // Generador simple de número de factura
      function generarNumeroFactura() {
        const aleatorio = Math.floor(Math.random() * 1000000).toString().padStart(6, "0");
        return `001-001-${aleatorio}`;
      }

      // Simula generación de archivos .txt de autorización y factura
      function generarFacturaFisica() {
        const emisor = document.getElementById("emisor").value;
        const rucEmisor = document.getElementById("rucEmisor").value;
        const direccionEmisor = document.getElementById("direccionEmisor").value;

        const cliente = document.getElementById("cliente").value;
        const rucCliente = document.getElementById("rucCliente").value;

        const detalle = document.getElementById("detalle").value;
        const cantidad = parseInt(document.getElementById("cantidad").value);
        const precio = parseFloat(document.getElementById("precio").value);

        const subtotal = cantidad * precio;
        const iva = subtotal * 0.12;
        const total = subtotal + iva;
        const fecha = new Date().toLocaleDateString();
        const numeroFactura = generarNumeroFactura();
        const numAutorizacion = Math.floor(Math.random() * 99999999999999999999).toString().padStart(19, "0");

        // Contenido de la autorización
        const contenidoAutorizacion = `
      AUTORIZACIÓN SRI
      -------------------------------
      RUC: ${rucEmisor}
      Número de autorización: ${numAutorizacion}
      Factura No.: ${numeroFactura}
      Fecha de autorización: ${fecha}
      -------------------------------
      Este archivo es válido como constancia de autorización
      `;

        // Contenido de la factura
        const contenidoFactura = `
      FACTURA FÍSICA SRI SIMULADA
      ------------------------------------------------
      Emisor: ${emisor}
      RUC: ${rucEmisor}
      Dirección: ${direccionEmisor}
      Factura No.: ${numeroFactura}
      Autorización SRI: ${numAutorizacion}
      Fecha: ${fecha}

      Cliente: ${cliente}
      CI/RUC: ${rucCliente}

      ------------------------------------------------
      Detalle: ${detalle}
      Cantidad: ${cantidad}
      Precio Unitario: $${precio.toFixed(2)}
      Subtotal: $${subtotal.toFixed(2)}
      IVA 12%: $${iva.toFixed(2)}
      Total: $${total.toFixed(2)}
      ------------------------------------------------
      "Este documento es válido para efectos tributarios"
      `;

        descargarTxt("autorizacion_sri.txt", contenidoAutorizacion);
        descargarTxt("factura_fisica.txt", contenidoFactura);
      }

      // Función para generar descarga de archivo .txt
      function descargarTxt(nombreArchivo, contenido) {
        const blob = new Blob([contenido], { type: "text/plain" });
        const enlace = document.createElement("a");
        enlace.href = URL.createObjectURL(blob);
        enlace.download = nombreArchivo;
        enlace.click();
      }


      function mostrarFacturacionFisica() {
        document.getElementById("facturacionFisica").style.display = "block";
        document.getElementById("facturacionElectronica").style.display = "none";
      }

      function mostrarFacturacionElectronica() {
        document.getElementById("facturacionFisica").style.display = "none";
        document.getElementById("facturacionElectronica").style.display = "block";
      }

      function generarNumeroFactura() {
        return `001-001-${Math.floor(Math.random() * 1000000).toString().padStart(6, "0")}`;
      }

      function descargarTxt(nombreArchivo, contenido) {
        const blob = new Blob([contenido], { type: "text/plain" });
        const enlace = document.createElement("a");
        enlace.href = URL.createObjectURL(blob);
        enlace.download = nombreArchivo;
        enlace.click();
      }

      // Factura Física
      function generarFacturaFisica() {
        const emisor = document.getElementById("emisor").value;
        const rucEmisor = document.getElementById("rucEmisor").value;
        const direccionEmisor = document.getElementById("direccionEmisor").value;
        const cliente = document.getElementById("cliente").value;
        const rucCliente = document.getElementById("rucCliente").value;
        const detalle = document.getElementById("detalle").value;
        const cantidad = parseInt(document.getElementById("cantidad").value);
        const precio = parseFloat(document.getElementById("precio").value);

        const subtotal = cantidad * precio;
        const iva = subtotal * 0.12;
        const total = subtotal + iva;
        const fecha = new Date().toLocaleDateString();
        const numeroFactura = generarNumeroFactura();
        const numAutorizacion = Math.floor(Math.random() * 99999999999999999999).toString().padStart(19, "0");

        const autorizacion = `
      AUTORIZACIÓN SRI
      -------------------------------
      RUC: ${rucEmisor}
      Número de autorización: ${numAutorizacion}
      Factura No.: ${numeroFactura}
      Fecha de autorización: ${fecha}
      -------------------------------
      Este archivo es válido como constancia de autorización
      `;

        const factura = `
      FACTURA FÍSICA SRI SIMULADA
      -------------------------------
      Emisor: ${emisor}
      RUC: ${rucEmisor}
      Dirección: ${direccionEmisor}
      Factura No.: ${numeroFactura}
      Autorización: ${numAutorizacion}
      Fecha: ${fecha}

      Cliente: ${cliente}
      CI/RUC: ${rucCliente}

      Detalle: ${detalle}
      Cantidad: ${cantidad}
      Precio Unitario: $${precio.toFixed(2)}
      Subtotal: $${subtotal.toFixed(2)}
      IVA 12%: $${iva.toFixed(2)}
      Total: $${total.toFixed(2)}
      -------------------------------
      "Este documento es válido para efectos tributarios"
      `;

        descargarTxt("autorizacion_fisica.txt", autorizacion);
        descargarTxt("factura_fisica.txt", factura);
      }

      // Factura Electrónica
      function generarFacturaElectronica() {
        const emisor = document.getElementById("emisorE").value;
        const rucEmisor = document.getElementById("rucEmisorE").value;
        const direccionEmisor = document.getElementById("direccionEmisorE").value;
        const cliente = document.getElementById("clienteE").value;
        const rucCliente = document.getElementById("rucClienteE").value;
        const detalle = document.getElementById("detalleE").value;
        const cantidad = parseInt(document.getElementById("cantidadE").value);
        const precio = parseFloat(document.getElementById("precioE").value);

        const subtotal = cantidad * precio;
        const iva = subtotal * 0.12;
        const total = subtotal + iva;

        const fecha = new Date().toISOString().split('T')[0];
        const numeroFactura = generarNumeroFactura();
        const claveAcceso = Math.floor(10000000000000000000000000000000000000 + Math.random() * 90000000000000000000000000000000000000).toString();

        const xml = `
      <factura id="comprobante" version="1.1.0">
        <infoTributaria>
          <razonSocial>${emisor}</razonSocial>
          <ruc>${rucEmisor}</ruc>
          <claveAcceso>${claveAcceso}</claveAcceso>
          <codDoc>01</codDoc>
          <estab>001</estab>
          <ptoEmi>001</ptoEmi>
          <secuencial>${numeroFactura.split('-')[2]}</secuencial>
          <dirMatriz>${direccionEmisor}</dirMatriz>
        </infoTributaria>
        <infoFactura>
          <fechaEmision>${fecha}</fechaEmision>
          <dirEstablecimiento>${direccionEmisor}</dirEstablecimiento>
          <razonSocialComprador>${cliente}</razonSocialComprador>
          <identificacionComprador>${rucCliente}</identificacionComprador>
          <totalSinImpuestos>${subtotal.toFixed(2)}</totalSinImpuestos>
          <totalConImpuestos>
            <totalImpuesto>
              <codigo>2</codigo>
              <codigoPorcentaje>2</codigoPorcentaje>
              <baseImponible>${subtotal.toFixed(2)}</baseImponible>
              <valor>${iva.toFixed(2)}</valor>
            </totalImpuesto>
          </totalConImpuestos>
          <importeTotal>${total.toFixed(2)}</importeTotal>
        </infoFactura>
        <detalles>
          <detalle>
            <descripcion>${detalle}</descripcion>
            <cantidad>${cantidad}</cantidad>
            <precioUnitario>${precio.toFixed(2)}</precioUnitario>
            <precioTotalSinImpuesto>${subtotal.toFixed(2)}</precioTotalSinImpuesto>
          </detalle>
        </detalles>
      </factura>
      `;

        const autorizacion = `
      AUTORIZACIÓN SRI - FACTURACIÓN ELECTRÓNICA
      --------------------------------------------
      RUC del Emisor: ${rucEmisor}
      Razón Social: ${emisor}
      Número de Factura: ${numeroFactura}
      Clave de Acceso: ${claveAcceso}
      Fecha de Autorización: ${fecha}
      Estado: AUTORIZADO
      --------------------------------------------
      Este documento sirve como constancia de autorización electrónica por el SRI
      `;

        descargarTxt("autorizacion_electronica.txt", autorizacion);
        descargarTxt("factura_electronica.xml", xml);
      }


//=======================================  VEHICULO  ===============================================


const marcasModelos = {
  "Chevrolet": ["Aveo", "Spark GT", "Tracker", "Onix"],
  "Toyota": ["Corolla", "Yaris", "RAV4", "Hilux"],
  "Ford": ["Fiesta", "Focus", "Escape", "Explorer"],
  "Kia": ["Rio", "Sportage", "Cerato", "Seltos"]
};

const datosGuardados = {};
const pagosRealizados = {};
const pagosConfirmados = new Set(); // Control para evitar pagos duplicados

// Listas de nombres para generación aleatoria
const nombresHombres = ["Juan", "Carlos", "Luis", "Miguel", "José", "Andrés"];
const apellidosHombres = ["Pérez", "García", "Rodríguez", "López", "Martínez"];
const nombresMujeres = ["María", "Luisa", "Ana", "Carla", "Sofía", "Elena"];
const apellidosMujeres = ["Gómez", "Díaz", "Fernández", "Morales", "Castro"];

// Variable global para guardar el último dato válido ingresado
let ultimoDatoIngresado = '';

function mostrarConsultaVehiculo(tipo) {
  const contenido = document.getElementById('contenidoVehiculo');
  const seccionPagos = document.getElementById('seccionPagosRealizados');
  seccionPagos.innerHTML = ''; // Limpiar pagos al mostrar consulta

  let placeholder = tipo === 'placa'
    ? 'Ingrese Placa, RAMV o CPN (Ej: ABC1234)'
    : 'Ingrese Código de Chasis (17 caracteres MAYÚSCULOS)';

  contenido.innerHTML = `
    <input type="text" id="inputDato" placeholder="${placeholder}" />
    <button onclick="validarDato('${tipo}')">Validar</button>
    <p id="mensaje" style="margin-top: 5px;"></p>
    <div id="infoVehiculo" style="margin-top: 20px;"></div>
    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
      <div id="infoPagoIzq" style="border: 1px solid #ccc; padding: 10px; border-radius: 6px; display: inline-block;"></div>
      <div id="metodosPagoDer" style="border: 1px solid #ccc; padding: 10px; border-radius: 6px; display: inline-block;"></div>
    </div>
    <div id="tablaReportes" style="margin-top: 30px; display: flex; justify-content: center;"></div>
  `;
}

function mostrarPagosRealizados() {
  const seccionPagos = document.getElementById('seccionPagosRealizados');
  const contenido = document.getElementById('contenidoVehiculo');

  contenido.innerHTML = '';  // Ocultamos consulta
  cerrarModal();
  cerrarModalPagoTarjeta();

  if (!ultimoDatoIngresado || !pagosRealizados[ultimoDatoIngresado] || pagosRealizados[ultimoDatoIngresado].length === 0) {
    seccionPagos.innerHTML = '<p style="color: gray;">No existen pagos registrados para este dato.</p>';
    return;
  }

  const pagos = pagosRealizados[ultimoDatoIngresado];
  seccionPagos.innerHTML = ''; // Limpiar antes de agregar
  pagos.forEach((pago, index) => {
    let filas = '';
    pago.datos.forEach(r => {
      filas += `
        <tr>
          <td>${r.rubro}</td>
          <td>${r.fecha}</td>
          <td>$${r.valor}</td>
        </tr>
      `;
    });

    seccionPagos.innerHTML += `
      <div style="margin-top: 20px; border: 1px solid #aaa; padding: 10px; border-radius: 6px; max-width: 850px;">
        <h3>Pago realizado en ${pago.anio}</h3>
        <table border="1" cellpadding="5" cellspacing="0" style="width: 100%; margin-bottom: 10px; text-align:center;">
          <thead>
            <tr>
              <th>Rubro</th>
              <th>Fecha</th>
              <th>Valor</th>
            </tr>
          </thead>
          <tbody>
            ${filas}
            <tr>
              <td colspan="2"><strong>Total</strong></td>
              <td><strong>$${pago.total}</strong></td>
            </tr>
          </tbody>
        </table>
        <button style="float:right;" onclick="verDetalles(${index}, '${ultimoDatoIngresado}')">🔍 Ver detalles</button>
      </div>
    `;
  });
}

function validarDato(tipo) {
  const input = document.getElementById('inputDato').value.trim().toUpperCase();
  ultimoDatoIngresado = input; // Guardar el dato ingresado para uso posterior

  const mensaje = document.getElementById('mensaje');
  mensaje.className = '';

  const regexPlaca = /^[A-Z]{3}\d{3,4}$/;
  const regexChasis = /^[A-Z0-9]{17}$/;

  if ((tipo === 'placa' && !regexPlaca.test(input)) || (tipo === 'chasis' && !regexChasis.test(input))) {
    mensaje.textContent = tipo === 'placa'
      ? 'Dato inválido. Formato: 3 letras MAYÚSCULAS y 3-4 números (Ej: ABC1234).'
      : 'Código inválido. Debe tener 17 caracteres MAYÚSCULOS y números.';
    mensaje.style.color = 'red';
    return;
  }

  mensaje.textContent = tipo === 'placa' ? 'Placa válida.' : 'Código de chasis válido.';
  mensaje.style.color = 'green';

  if (datosGuardados[input]) {
    renderizarDatos(datosGuardados[input], tipo, input);
  } else {
    const data = generarDatosAleatorios(tipo, input);
    datosGuardados[input] = data;
    renderizarDatos(data, tipo, input);
  }
}

function generarDatosAleatorios(tipo, input) {
  const marcas = Object.keys(marcasModelos);
  const marca = marcas[Math.floor(Math.random() * marcas.length)];
  const modelo = marcasModelos[marca][Math.floor(Math.random() * 4)];
  const anio = Math.floor(Math.random() * (2024 - 2005 + 1)) + 2005;
  const anioPago = new Date().getFullYear();

  const rubros = ['Multa', 'Impuesto', 'Revisión técnica', 'Parqueo indebido', 'Otros cargos'];
  const cantidad = Math.floor(Math.random() * 3) + 1;

  let reportes = [], total = 0;
  for (let i = 0; i < cantidad; i++) {
    const rubro = rubros[Math.floor(Math.random() * rubros.length)];
    const valor = Math.floor(Math.random() * (184 - 34 + 1)) + 34;
    total += valor;
    reportes.push({ rubro, fecha: generarFechaAleatoria(), valor });
  }

  return { marca, modelo, anio, anioPago, reportes, total, datoIngresado: input };
}

function renderizarDatos(data, tipo, input) {
  document.getElementById('infoVehiculo').innerHTML = `
    <h3>Información del Vehículo</h3>
    <p><strong>${tipo === 'placa' ? 'Placa' : 'Chasis'}:</strong> ${input}</p>
    <p><strong>Marca:</strong> ${data.marca}</p>
    <p><strong>Modelo:</strong> ${data.modelo}</p>
    <p><strong>Año:</strong> ${data.anio}</p>
  `;

  document.getElementById('infoPagoIzq').innerHTML = `
    <strong style="color: blue;">ÚLTIMO PAGO</strong><br>
    Año: ${data.anioPago}
  `;

  let filas = '';
  data.reportes.forEach(r => {
    filas += `
      <tr>
        <td>${r.rubro}</td>
        <td>${r.fecha}</td>
        <td>$${r.valor}</td>
      </tr>
    `;
  });

  document.getElementById('tablaReportes').innerHTML = `
    <h2 style="margin-top: 20px; text-align: center;">Reportes de pago del vehículo</h2>
    <table border="1" cellpadding="8" cellspacing="0" style="width: 90%; max-width: 800px; text-align: center;">
      <thead>
        <tr>
          <th>Rubro</th>
          <th>Fecha</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody>
        ${filas}
        <tr>
          <td colspan="2"><strong>Total a Cancelar</strong></td>
          <td><strong>$${data.total}</strong></td>
        </tr>
      </tbody>
    </table>
  `;

  // Solo habilitar botones si NO se ha pagado ya ese año con esa placa
  const keyPago = `${data.datoIngresado}_${data.anioPago}`;
  const pagoYaRealizado = pagosConfirmados.has(keyPago);

  document.getElementById('metodosPagoDer').innerHTML = `
    <h4 style="text-transform: uppercase;">MÉTODOS DE PAGO</h4>
    <p style="text-transform: uppercase;">Total: <span style="font-weight: normal;">$${data.total}</span></p>
    <div style="display: flex; gap: 10px;">
      <button ${pagoYaRealizado ? 'disabled' : ''} onclick="abrirModalPagoTarjeta('${data.datoIngresado}')">Tarjeta</button>
      <button ${pagoYaRealizado ? 'disabled' : ''} onclick="generarBoleto('${data.datoIngresado}', '${data.total}')">Boleto de Pago</button>
    </div>
    ${pagoYaRealizado ? '<p style="color: green; font-weight: bold;">Pago ya realizado para esta placa y año.</p>' : ''}
  `;
}

function generarFechaAleatoria() {
  const fechaActual = new Date();
  const inicio = new Date(fechaActual.getFullYear(), 0, 1); // 1 de enero del año actual
  const fin = fechaActual; // hoy
  const diferencia = fin.getTime() - inicio.getTime();
  const nuevaFecha = new Date(inicio.getTime() + Math.random() * diferencia);
  return nuevaFecha.toISOString().split('T')[0]; // formato yyyy-mm-dd
}

function guardarDatos() {
  const propietario = document.getElementById("propietario").value;
  const marca = document.getElementById("marca").value;
  const modelo = document.getElementById("modelo").value;

  if (!propietario || !marca || !modelo) {
    alert("Por favor complete todos los campos.");
    return;
  }

  const reporte = {
    propietario,
    marca,
    modelo,
    fecha: generarFechaAleatoria() // fecha limitada al día actual
  };

  datosGuardados.push(reporte);
  mostrarTabla();
}


function generarBoleto(placa, total) {
  if (verificarPagoUnico(placa)) {
    confirmarPago(placa, 'Boleto de Pago');
    const contenido = `BOLETO DE PAGO\n\nDato: ${placa}\nTotal a pagar: $${total}\nCuenta: 1234567890\nBanco: Banco Institucional\nReferencia: ${Math.floor(Math.random() * 1000000000)}`;
    const blob = new Blob([contenido], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `boleto_pago_${placa}.txt`;
    link.click();
  } else {
    alert('El pago ya fue realizado para esta placa y año.');
  }
}

// Valida si se puede pagar o ya fue pagado
function verificarPagoUnico(placa) {
  const pago = datosGuardados[placa];
  if (!pago) return false;
  const keyPago = `${placa}_${pago.anioPago}`;
  return !pagosConfirmados.has(keyPago);
}

function abrirModalPagoTarjeta(placa) {
  const pago = datosGuardados[placa];
  if (!pago) return alert('Debe validar primero la placa.');

  if (!verificarPagoUnico(placa)) {
    alert('Ya se ha realizado el pago para esta placa y reporte.');
    return;
  }

  const modal = document.getElementById('modalPagoTarjeta');
  modal.innerHTML = `
    <h2>Pago con Tarjeta - Total: $${pago.total}</h2>
    <label>
      Número de tarjeta:<br/>
      <input type="text" id="inputNumeroTarjeta" maxlength="16" placeholder="1234123412341234" />
    </label><br/><br/>
    <label>
      Fecha de vencimiento (MM/YYYY):<br/>
      <input type="text" id="inputFechaVencimiento" maxlength="7" placeholder="MM/YYYY" />
    </label><br/><br/>
    <label>
      Código de seguridad:<br/>
      <input type="password" id="inputCodigoSeguridad" maxlength="4" placeholder="123" />
    </label><br/><br/>
    <button onclick="procesarPagoTarjeta('${placa}')">Confirmar Pago</button>
    <button onclick="cerrarModalPagoTarjeta()">Cancelar</button>
  `;
  modal.style.display = 'block';
}

function procesarPagoTarjeta(placa) {
  const numeroTarjeta = document.getElementById('inputNumeroTarjeta').value.trim();
  const fechaVenc = document.getElementById('inputFechaVencimiento').value.trim();
  const codigoSeguridad = document.getElementById('inputCodigoSeguridad').value.trim();

  if (!/^\d{16}$/.test(numeroTarjeta)) {
    alert('Número de tarjeta inválido. Debe tener 16 dígitos numéricos.');
    return;
  }

  const fechaMatch = fechaVenc.match(/^(\d{2})\/(\d{4})$/);
  if (!fechaMatch) {
    alert('Fecha de vencimiento inválida. Debe tener formato MM/YYYY.');
    return;
  }
  const mes = parseInt(fechaMatch[1], 10);
  const año = parseInt(fechaMatch[2], 10);
  const añoActual = new Date().getFullYear();
  if (mes < 1 || mes > 12 || año < añoActual || año > 2027) {
    alert('Fecha de vencimiento fuera de rango.');
    return;
  }

  if (!/^\d{3,4}$/.test(codigoSeguridad)) {
    alert('Código de seguridad inválido. Debe tener 3 o 4 dígitos numéricos.');
    return;
  }

  confirmarPago(placa, 'Tarjeta');

  alert('Pago realizado exitosamente.');

  cerrarModalPagoTarjeta();
  mostrarPagosRealizados();
}

function cerrarModalPagoTarjeta() {
  const modal = document.getElementById('modalPagoTarjeta');
  modal.style.display = 'none';
}

function confirmarPago(placa, metodo = 'Tarjeta') {
  const pago = datosGuardados[placa];
  if (!pago) return;

  const keyPago = `${placa}_${pago.anioPago}`;
  if (pagosConfirmados.has(keyPago)) {
    alert('Ya se ha realizado el pago para esta placa y reporte.');
    return;
  }

  // Generar datos aleatorios persona (hombre o mujer al azar)
  const esHombre = Math.random() < 0.5;
  let nombre, apellido;
  if (esHombre) {
    nombre = nombresHombres[Math.floor(Math.random() * nombresHombres.length)];
    apellido = apellidosHombres[Math.floor(Math.random() * apellidosHombres.length)];
  } else {
    nombre = nombresMujeres[Math.floor(Math.random() * nombresMujeres.length)];
    apellido = apellidosMujeres[Math.floor(Math.random() * apellidosMujeres.length)];
  }

  // Generar cédula aleatoria (ecuador, 10 dígitos)
  const cedula = generarCedulaAleatoria();

  pagosConfirmados.add(keyPago);

  if (!pagosRealizados[placa]) pagosRealizados[placa] = [];

  pagosRealizados[placa].push({
    anio: pago.anioPago,
    datos: pago.reportes,
    total: pago.total,
    metodoPago: metodo,
    nombreCompleto: `${nombre} ${apellido}`,
    cedula,
    datoIngresado: placa
  });

  // Actualizar interfaz para deshabilitar botones después del pago
  renderizarDatos(pago, 'placa', placa);
}

function generarCedulaAleatoria() {
  const provincia = String(Math.floor(Math.random() * 24) + 1).padStart(2, '0'); // 01 a 24
  const tercerDigito = Math.floor(Math.random() * 6); // 0 a 5 (persona natural)
  const coeficientes = [2, 1, 2, 1, 2, 1, 2, 1, 2];
  let cedulaSinVerificador = provincia + tercerDigito;

  // Generar los siguientes 6 dígitos aleatorios (total 9 sin el verificador)
  for (let i = 0; i < 6; i++) {
    cedulaSinVerificador += Math.floor(Math.random() * 10).toString();
  }

  // Calcular dígito verificador
  let suma = 0;
  for (let i = 0; i < 9; i++) {
    let valor = parseInt(cedulaSinVerificador[i]) * coeficientes[i];
    if (valor >= 10) valor -= 9;
    suma += valor;
  }

  const residuo = suma % 10;
  const digitoVerificador = residuo === 0 ? 0 : 10 - residuo;

  return cedulaSinVerificador + digitoVerificador;
}


function verDetalles(index, placa) {
  const pago = pagosRealizados[placa][index];
  const modal = document.getElementById('modalDetallesPago');

  let filasDetalle = '';
  pago.datos.forEach(r => {
    filasDetalle += `
      <tr>
        <td>${r.rubro}</td>
        <td>${r.fecha}</td>
        <td>$${r.valor}</td>
      </tr>
    `;
  });

  modal.innerHTML = `
    <h2>Detalles del pago (${pago.anio})</h2>
    <p><strong>Nombre:</strong> ${pago.nombreCompleto}</p>
    <p><strong>Cédula:</strong> ${pago.cedula}</p>
    <p><strong>Dato ingresado:</strong> ${pago.datoIngresado}</p>
    <p><strong>Método de pago:</strong> ${pago.metodoPago}</p>
    <table border="1" cellpadding="6" cellspacing="0" style="width: 100%; text-align:center; margin-top: 10px;">
      <thead>
        <tr><th>Rubro</th><th>Fecha</th><th>Valor</th></tr>
      </thead>
      <tbody>
        ${filasDetalle}
        <tr>
          <td colspan="2"><strong>Total</strong></td>
          <td><strong>$${pago.total}</strong></td>
        </tr>
      </tbody>
    </table>
    <button onclick="cerrarModal()" style="margin-top: 15px;">Cerrar</button>
  `;
  modal.style.display = 'block';
}

function cerrarModal() {
  const modal = document.getElementById('modalDetallesPago');
  modal.style.display = 'none';
}



//======================================================================================================================


        // Simulación de datos base (podrías conectar con tus arrays reales más adelante)
        // 🟦 Valores iniciales
        let datosSistema = {
          facturas: Math.floor(Math.random() * 3001) + 2000,
          anexos: Math.floor(Math.random() * 3001) + 2000,
          deudas: Math.floor(Math.random() * 3001) + 2000,
          reportesVehiculos: Math.floor(Math.random() * 3001) + 2000
        };

        function generarVariacionPorcentaje(valor) {
          const variacion = Math.floor(valor * 0.15);
          const cambio = Math.floor(Math.random() * (variacion + 1));
          const suma = Math.random() < 0.5 ? -cambio : cambio;
          return Math.max(0, valor + suma);
        }

        function obtenerDatosVariables() {
          return {
            facturas: generarVariacionPorcentaje(datosSistema.facturas),
            anexos: generarVariacionPorcentaje(datosSistema.anexos),
            deudas: generarVariacionPorcentaje(datosSistema.deudas),
            reportesVehiculos: generarVariacionPorcentaje(datosSistema.reportesVehiculos)
          };
        }

        let graficaSistema = null;
        let intervaloGrafica = null;

        function mostrarGrafica() {
          document.querySelectorAll('.modulo').forEach(m => m.classList.add('hidden'));
          document.getElementById('grafica').classList.remove('hidden');

          const ctx = document.getElementById('graficaSistema').getContext('2d');
          const datosIniciales = obtenerDatosVariables();

          graficaSistema = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: [
                'Facturas Generadas',
                'Anexos Procesados',
                'Deudas Registradas',
                'Reportes de Vehículos'
              ],
              datasets: [{
                label: 'Cantidad total',
                data: [
                  datosIniciales.facturas,
                  datosIniciales.anexos,
                  datosIniciales.deudas,
                  datosIniciales.reportesVehiculos
                ],
                backgroundColor: ['#007bff88', '#28a74588', '#ffc10788', '#dc354588'],
                borderColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
              },
              plugins: {
                title: {
                  display: true,
                  text: 'Resumen General del Sistema'
                },
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            }
          });

          // Evita múltiples intervalos
          if (intervaloGrafica) clearInterval(intervaloGrafica);

          intervaloGrafica = setInterval(() => {
            const nuevosDatos = obtenerDatosVariables();
            const nuevosValores = [
              nuevosDatos.facturas,
              nuevosDatos.anexos,
              nuevosDatos.deudas,
              nuevosDatos.reportesVehiculos
            ];

            // 🔄 Actualiza solo los datos sin destruir la gráfica
            graficaSistema.data.datasets[0].data = nuevosValores;
            graficaSistema.update();
          }, 6000);
        }


      let deudasUsuario = [];

        function mostrarConsultaDeudas() {
          // Limpiar contenido y deshabilitar botones pagar/facilidades
          document.getElementById("contenidoDeudas").innerHTML = `
            <h3>Consulta de Deudas</h3>
            <label>Cédula/RUC:</label>
            <input type="text" id="cedulaConsulta" placeholder="Ej: 0102030405">
            <button onclick="validarConsultaDeudas()">Consultar</button>
            <div id="resultadoConsulta" style="margin-top: 10px;"></div>
          `;
          document.getElementById("btnPagarDeudas").disabled = true;
          document.getElementById("btnFacilidadesPago").disabled = true;
        }

        function validarConsultaDeudas() {
          const cedula = document.getElementById("cedulaConsulta").value.trim();
          const resultadoDiv = document.getElementById("resultadoConsulta");

          if (cedula.length < 10) {
            alert("Por favor ingresa un número válido de cédula o RUC.");
            return;
          }

          // Simulación de consulta: Generamos aleatoriamente si hay o no deuda
          const tieneDeuda = Math.random() < 0.6; // 60% probabilidad de deuda

          if (!tieneDeuda) {
            deudasUsuario = []; // Vaciar listado
            resultadoDiv.innerHTML = `<p style="color:green;">No tiene deudas registradas para el RUC/Cédula ${cedula}.</p>`;
            document.getElementById("btnPagarDeudas").disabled = true;
            document.getElementById("btnFacilidadesPago").disabled = true;
            return;
          }

          // Si tiene deudas, simulamos un listado (puedes ajustar estos datos)
          deudasUsuario = [
            { id: "D001", descripcion: "Impuesto Renta 2024", monto: 350.00 },
            { id: "D002", descripcion: "Multa por declaración tardía", monto: 50.00 },
          ];

          let htmlReporte = `<p style="color:red;">Se encontraron ${deudasUsuario.length} deudas para el RUC/Cédula ${cedula}:</p><ul>`;
          deudasUsuario.forEach(deuda => {
            htmlReporte += `<li><strong>${deuda.descripcion}</strong> - $${deuda.monto.toFixed(2)} (ID: ${deuda.id})</li>`;
          });
          htmlReporte += "</ul>";

          resultadoDiv.innerHTML = htmlReporte;

          // Habilitar botones de pago y facilidades
          document.getElementById("btnPagarDeudas").disabled = false;
          document.getElementById("btnFacilidadesPago").disabled = false;
        }

        function mostrarPagoDeudas() {
          if(deudasUsuario.length === 0){
            alert("No hay deudas registradas para pagar.");
            return;
          }

          let contenido = `
            <h3>Pagar Deudas</h3>
            <label>Selecciona la deuda a pagar:</label>
            <select id="selectDeudaPago">
              ${deudasUsuario.map(d => `<option value="${d.id}">${d.descripcion} - $${d.monto.toFixed(2)}</option>`).join('')}
            </select>
            <label>Monto a pagar:</label>
            <input type="number" id="montoPago" min="0.01" step="0.01" placeholder="Ej: 100.00" value="${deudasUsuario[0].monto.toFixed(2)}">
            <button onclick="validarPagoDeudas()">Pagar</button>
            <div id="mensajePago" style="margin-top:10px;"></div>
          `;

          document.getElementById("contenidoDeudas").innerHTML = contenido;

          // Al cambiar deuda seleccionada, actualizar monto automáticamente
          document.getElementById("selectDeudaPago").addEventListener('change', function(){
            const selectedId = this.value;
            const deuda = deudasUsuario.find(d => d.id === selectedId);
            if(deuda){
              document.getElementById("montoPago").value = deuda.monto.toFixed(2);
            }
          });
        }

        function validarPagoDeudas() {
          const id = document.getElementById("selectDeudaPago").value;
          const montoInput = document.getElementById("montoPago").value;
          const monto = parseFloat(montoInput);
          const mensajeDiv = document.getElementById("mensajePago");

          if (!id || isNaN(monto) || monto <= 0) {
            alert("Completa correctamente los campos para procesar el pago.");
            return;
          }

          const deuda = deudasUsuario.find(d => d.id === id);
          if (!deuda) {
            alert("Deuda no encontrada.");
            return;
          }

          if (monto > deuda.monto) {
            alert(`El monto a pagar no puede ser mayor al total de la deuda ($${deuda.monto.toFixed(2)}).`);
            return;
          }

          // Simular pago parcial o total
          deuda.monto -= monto;

          let msg = `Pago realizado por $${monto.toFixed(2)} para la deuda "${deuda.descripcion}". `;

          if (deuda.monto <= 0.01) {
            // Eliminar deuda si saldo es 0 o menor
            deudasUsuario = deudasUsuario.filter(d => d.id !== id);
            msg += "Deuda saldada completamente.";
          } else {
            msg += `Saldo restante: $${deuda.monto.toFixed(2)}.`;
          }

          mensajeDiv.innerHTML = `<p style="color:green;">${msg}</p>`;

          // Actualizar select y monto
          if(deudasUsuario.length === 0){
            document.getElementById("contenidoDeudas").innerHTML = `<p>No quedan deudas pendientes.</p>`;
            document.getElementById("btnPagarDeudas").disabled = true;
            document.getElementById("btnFacilidadesPago").disabled = true;
          } else {
            mostrarPagoDeudas();
          }
        }

        function mostrarFacilidadesPago() {
          if(deudasUsuario.length === 0){
            alert("No hay deudas registradas para solicitar facilidades.");
            return;
          }

          let contenido = `
            <h3>Solicitar Facilidades de Pago</h3>
            <label>Cédula/RUC:</label>
            <input type="text" id="cedulaFacilidad" placeholder="Ej: 0102030405">
            <label>Cuotas:</label>
            <input type="number" id="cuotas" min="1" placeholder="Ej: 6">
            <button onclick="validarFacilidadesPago()">Solicitar</button>
            <div id="mensajeFacilidad" style="margin-top:10px;"></div>
          `;

          document.getElementById("contenidoDeudas").innerHTML = contenido;
        }

        function validarFacilidadesPago() {
          const cedula = document.getElementById("cedulaFacilidad").value.trim();
          const cuotas = parseInt(document.getElementById("cuotas").value);
          const mensajeDiv = document.getElementById("mensajeFacilidad");

          if (cedula.length < 10) {
            alert("Por favor ingresa un número válido de cédula o RUC.");
            return;
          }
          if (isNaN(cuotas) || cuotas < 1) {
            alert("Ingresa un número válido de cuotas.");
            return;
          }
          if (deudasUsuario.length === 0) {
            alert("No hay deudas para solicitar facilidades de pago.");
            return;
          }

          mensajeDiv.innerHTML = `<p style="color:green;">Solicitud enviada para ${cuotas} cuotas al RUC/Cédula ${cedula}. (Simulación)</p>`;
        }
    </script>

    <footer  style="text-align:justify; background: #004b8d; color: white; position: fixed; bottom: 0; width: 100%; height: auto; margin: auto;">
      © 2025 Sistema Web SRI
    </footer>
  </body>
</html>
